<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>R√∂wert - Gravel Coach</title>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A0E17">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="R√∂wert">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0A0E17;
            --bg-card: #131927;
            --bg-card-light: #1A2235;
            --bg-elevated: #232D42;
            
            --accent-primary: #E8944C;
            --accent-glow: rgba(232, 148, 76, 0.4);
            --accent-secondary: #4ECDC4;
            
            --status-green: #22C55E;
            --status-red: #EF4444;
            --status-blue: #3B82F6;
            --status-purple: #A855F7;
            --status-yellow: #EAB308;
            
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            
            --border: #2D3A52;
            --radius: 16px;
            --radius-sm: 10px;
            
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }

        /* ============================================
           HEADER
        ============================================ */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(to bottom, var(--bg-deep) 0%, var(--bg-deep) 80%, transparent 100%);
            padding: 16px 16px 24px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), #D97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-ftp {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ftp:hover { background: var(--bg-card-light); }
        .btn-ftp .label { font-size: 9px; color: var(--text-muted); font-weight: 600; }
        .btn-ftp .value { font-size: 14px; color: var(--accent-primary); font-weight: 700; }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-import {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        .btn-import:hover { transform: scale(1.05); }

        .btn-view {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-view:hover { background: var(--bg-card-light); }
        .btn-view.active { background: var(--accent-secondary); color: var(--bg-deep); }

        /* ============================================
           WEEK SUMMARY BAR
        ============================================ */
        .week-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .summary-item .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-item .sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .trend-up { color: var(--status-green); }
        .trend-down { color: var(--status-red); }
        .trend-neutral { color: var(--text-muted); }

        /* ============================================
           FORM CURVE
        ============================================ */
        .form-curve {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 16px;
        }

        .form-curve-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .form-curve-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-status {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .form-status.fresh { background: var(--status-green); color: #000; }
        .form-status.building { background: var(--status-blue); color: #fff; }
        .form-status.tired { background: var(--status-yellow); color: #000; }
        .form-status.overreaching { background: var(--status-red); color: #fff; }

        .form-bars {
            display: flex;
            align-items: flex-end;
            gap: 6px;
            height: 60px;
        }

        .form-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .form-bar {
            width: 100%;
            background: var(--bg-elevated);
            border-radius: 4px;
            position: relative;
            min-height: 8px;
            transition: all 0.3s ease;
        }

        .form-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: height 0.5s ease;
        }

        .form-bar-label {
            font-size: 9px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-bar-wrapper.current .form-bar {
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .form-bar-wrapper.current .form-bar-label {
            color: var(--accent-primary);
        }

        /* ============================================
           WEEK TABS
        ============================================ */
        .week-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
        }

        .week-tabs::-webkit-scrollbar { display: none; }

        .week-tab {
            flex-shrink: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .week-tab:hover { background: var(--bg-card-light); }

        .week-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .week-tab .week-num {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .week-tab.active .week-num { color: var(--bg-deep); }

        .week-tab .week-progress {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .week-tab.active .week-progress { color: var(--bg-deep); opacity: 0.8; }

        /* ============================================
           CONTENT
        ============================================ */
        .content {
            padding: 0 16px 100px;
        }

        /* ============================================
           WORKOUT CARDS
        ============================================ */
        .workout-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .workout-card.completed {
            opacity: 0.5;
            filter: grayscale(0.3);
        }

        .workout-card.is-today {
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px var(--accent-glow), inset 0 0 30px rgba(232, 148, 76, 0.05);
        }

        .card-header {
            display: flex;
            background: var(--bg-card-light);
        }

        .intensity-bar {
            width: 4px;
            flex-shrink: 0;
        }

        .intensity-bar.recovery { background: var(--status-green); }
        .intensity-bar.endurance { background: var(--status-blue); }
        .intensity-bar.threshold { background: var(--status-red); }
        .intensity-bar.sweetspot { background: var(--accent-primary); }

        .card-header-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            gap: 12px;
        }

        .card-header-left {
            flex: 1;
            min-width: 0;
        }

        .card-date-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .card-date {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .today-badge {
            background: var(--accent-primary);
            color: var(--bg-deep);
            font-size: 9px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px var(--accent-glow); }
            50% { box-shadow: 0 0 20px var(--accent-glow); }
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .card-duration {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .btn-edit {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .btn-edit:hover, .btn-edit.active {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Card Body */
        .card-body {
            padding: 14px;
        }

        .card-body.compact { display: none; }

        .workout-card.compact-view .card-body.full { display: none; }
        .workout-card.compact-view .card-body.compact { display: flex; align-items: center; justify-content: space-between; }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        /* Weather Alert */
        .weather-alert {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.15), transparent);
            border-left: 3px solid var(--status-yellow);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-alert.good {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.15), transparent);
            border-left-color: var(--status-green);
        }

        .weather-good {
            color: var(--status-green) !important;
        }

        .weather-icon {
            font-size: 24px;
        }

        .weather-info {
            flex: 1;
        }

        .weather-temp {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .weather-desc {
            font-size: 11px;
            color: var(--status-yellow);
        }

        /* Intervals Box */
        .intervals-box {
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 12px;
        }

        .intervals-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--status-green);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Info Boxes */
        .info-box {
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid;
        }

        .info-box.nutrition {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
            border-color: var(--status-red);
        }

        .info-box.technique {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
            border-color: var(--status-blue);
        }

        .info-box.coach-notes {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            border-color: var(--status-purple);
        }

        .info-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-box.nutrition .info-label { color: var(--status-red); }
        .info-box.technique .info-label { color: var(--status-blue); }
        .info-box.coach-notes .info-label { color: var(--status-purple); }

        .info-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .btn-video {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #DC2626;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 8px;
        }

        /* Comparison Box */
        .comparison-box {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            border-left: 3px solid var(--status-purple);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 12px;
            margin-bottom: 12px;
        }

        .comparison-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--status-purple);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .comparison-item .label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .comparison-item .value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .comparison-item .diff {
            font-size: 11px;
            margin-top: 2px;
        }

        .comparison-item .diff.good { color: var(--status-green); }
        .comparison-item .diff.warn { color: var(--status-yellow); }

        .comparison-notes {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .comparison-feeling {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .comparison-feeling .label {
            color: var(--text-muted);
        }

        .strava-badge {
            background: #FC4C02;
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }

        .card-actions-left {
            display: flex;
            gap: 8px;
        }

        .card-actions-right {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 10px 16px;
            border-radius: 24px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-delete {
            background: transparent;
            color: var(--status-red);
            padding: 10px 12px;
        }

        .btn-log {
            background: rgba(168, 85, 247, 0.2);
            color: var(--status-purple);
        }

        .btn-log:hover { background: rgba(168, 85, 247, 0.3); }

        .btn-complete {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .btn-complete:hover { background: var(--bg-card-light); }

        .btn-complete.active {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Compact Card Actions */
        .compact-actions {
            display: flex;
            gap: 8px;
        }

        .compact-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ============================================
           MODALS
        ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius) var(--radius) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            font-size: 15px;
            color: var(--text-primary);
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        textarea.form-input {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card-light);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Feeling Rating */
        .feeling-row {
            display: flex;
            gap: 8px;
        }

        .feeling-btn {
            flex: 1;
            aspect-ratio: 1;
            max-width: 50px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-card-light);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.4;
        }

        .feeling-btn.active {
            opacity: 1;
            border-color: var(--accent-primary);
            background: rgba(232, 148, 76, 0.2);
            transform: scale(1.1);
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--accent-primary);
            color: var(--bg-deep);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .btn-primary:hover { transform: scale(1.02); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Strava Button */
        .btn-strava {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            background: #FC4C02;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-strava.connected {
            background: var(--bg-elevated);
            color: var(--status-red);
        }

        .strava-status {
            font-size: 12px;
            color: var(--status-green);
            text-align: center;
            margin-bottom: 8px;
        }

        /* Strava Selector */
        .btn-load-strava {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px dashed var(--border);
            background: transparent;
            color: #FC4C02;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .btn-load-strava:hover {
            background: rgba(252, 76, 2, 0.1);
        }

        .btn-load-strava.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .strava-activities-list {
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .strava-activity-item {
            background: var(--bg-deep);
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .strava-activity-item:hover {
            border-color: #FC4C02;
        }

        .strava-activity-item.selected {
            border-color: #FC4C02;
            background: rgba(252, 76, 2, 0.1);
        }

        .strava-activity-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .strava-activity-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .strava-activity-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Danger Button */
        .btn-danger {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--status-red);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        /* Log Workout Info */
        .log-workout-header {
            margin-bottom: 20px;
        }

        .log-workout-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .log-workout-date {
            font-size: 13px;
            color: var(--accent-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .empty-link {
            color: var(--accent-primary);
            text-decoration: underline;
            cursor: pointer;
        }

        /* ============================================
           ANIMATIONS
        ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .workout-card {
            animation: fadeIn 0.3s ease forwards;
        }

        /* ============================================
           UTILITY
        ============================================ */
        .hidden { display: none !important; }

        /* ============================================
           COLLAPSIBLE HEADER
        ============================================ */
        .header-collapsible {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .header-collapsible.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .btn-collapse {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-collapse:hover { background: var(--bg-card-light); }

        .btn-collapse .chevron {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .btn-collapse.collapsed .chevron {
            transform: rotate(180deg);
        }

        /* ============================================
           HERO WORKOUT
        ============================================ */
        .hero-workout {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(232, 148, 76, 0.12) 100%);
            border: 1px solid var(--accent-primary);
            border-radius: var(--radius);
            margin-bottom: 24px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 40px var(--accent-glow), inset 0 0 40px rgba(232, 148, 76, 0.05);
            animation: heroGlow 3s ease-in-out infinite;
        }

        .hero-workout.completed {
            opacity: 0.6;
            filter: grayscale(0.3);
            animation: none;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
            border-color: var(--status-green);
        }

        @keyframes heroGlow {
            0%, 100% { box-shadow: 0 0 30px var(--accent-glow), inset 0 0 30px rgba(232, 148, 76, 0.05); }
            50% { box-shadow: 0 0 50px var(--accent-glow), inset 0 0 50px rgba(232, 148, 76, 0.08); }
        }

        .hero-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--accent-primary);
            color: var(--bg-deep);
            font-size: 11px;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 0 0 var(--radius-sm) 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hero-body {
            padding: 20px;
        }

        .hero-title {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .hero-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .hero-duration {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .hero-intensity {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .hero-intensity.recovery { background: rgba(34, 197, 94, 0.2); color: var(--status-green); }
        .hero-intensity.endurance { background: rgba(59, 130, 246, 0.2); color: var(--status-blue); }
        .hero-intensity.threshold { background: rgba(239, 68, 68, 0.2); color: var(--status-red); }
        .hero-intensity.sweetspot { background: rgba(232, 148, 76, 0.2); color: var(--accent-primary); }

        .hero-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .hero-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .hero-actions .btn-action {
            padding: 12px 20px;
            font-size: 13px;
        }

        /* ============================================
           CARD TABS
        ============================================ */
        .card-tabs {
            display: flex;
            gap: 4px;
            padding: 0 14px;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .card-tab {
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .card-tab:hover {
            color: var(--text-secondary);
        }

        .card-tab.active {
            border-bottom-color: currentColor;
        }

        .card-tab.tab-intervals.active { color: var(--status-green); }
        .card-tab.tab-nutrition.active { color: var(--status-red); }
        .card-tab.tab-technique.active { color: var(--status-blue); }
        .card-tab.tab-coach.active { color: var(--status-purple); }

        .card-tab-content {
            display: none;
            padding: 14px;
        }

        .card-tab-content.active {
            display: block;
        }

        .card-body-always {
            padding: 14px;
        }

        .card-body-always .card-desc {
            margin-bottom: 0;
        }

        .card-body-always .weather-alert {
            margin-top: 12px;
            margin-bottom: 0;
        }

        .card-body-always .comparison-box {
            margin-top: 12px;
            margin-bottom: 0;
        }

        .card-body-tabbed .intervals-box {
            margin-bottom: 0;
        }

        .card-body-tabbed .info-box {
            margin-bottom: 0;
        }

        /* ============================================
           PLAN OVERVIEW
        ============================================ */
        .plan-week {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .plan-week:last-child { border-bottom: none; }

        .plan-week.current {
            border-left: 3px solid var(--accent-primary);
            padding-left: 12px;
            margin-left: -4px;
        }

        .plan-week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .plan-week-header .plan-week-progress {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .plan-workout-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 13px;
        }

        .plan-workout-row:hover { background: var(--bg-elevated); }

        .plan-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .plan-dot.recovery { background: var(--status-green); }
        .plan-dot.endurance { background: var(--status-blue); }
        .plan-dot.threshold { background: var(--status-red); }
        .plan-dot.sweetspot { background: var(--accent-primary); }

        .plan-workout-date {
            color: var(--text-muted);
            font-size: 12px;
            min-width: 52px;
            font-family: 'JetBrains Mono', monospace;
        }

        .plan-workout-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-workout-duration {
            color: var(--text-muted);
            font-size: 12px;
            white-space: nowrap;
        }

        .plan-workout-status {
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .plan-workout-row.completed {
            opacity: 0.5;
        }

        .plan-workout-row.completed .plan-workout-title {
            text-decoration: line-through;
        }

        .plan-workout-row.is-today {
            background: rgba(232, 148, 76, 0.1);
            border: 1px solid rgba(232, 148, 76, 0.3);
        }

        .plan-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">üö¥</div>
                <div class="logo-text">
                    <h1>R√ñWERT</h1>
                    <span>Gravel Coach</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-ftp" onclick="openSettings()">
                    <span class="label">FTP</span>
                    <span class="value" id="ftp-display">185W</span>
                </button>
                <button class="btn-collapse" id="btn-collapse" onclick="toggleHeaderCollapse()" title="Header einklappen">
                    <span class="chevron">‚ñ≤</span>
                </button>
                <button class="btn-icon btn-view" onclick="openPlanOverview()" title="Gesamtplan">üìã</button>
                <button class="btn-icon btn-view" onclick="toggleCompactMode()" id="btn-compact" title="Kompakt-Ansicht">‚ò∞</button>
                <button class="btn-icon btn-import" onclick="openImport()" title="Import">Ôºã</button>
            </div>
        </div>

        <!-- Collapsible: Summary + Form Curve -->
        <div class="header-collapsible" id="header-collapsible">
            <!-- Week Summary -->
            <div class="week-summary" id="week-summary">
                <div class="summary-item">
                    <div class="label">Soll</div>
                    <div class="value" id="summary-target">0h</div>
                </div>
                <div class="summary-item">
                    <div class="label">Ist</div>
                    <div class="value" id="summary-actual">0h</div>
                    <div class="sub" id="summary-percent">0%</div>
                </div>
                <div class="summary-item">
                    <div class="label">Erledigt</div>
                    <div class="value" id="summary-completed">0/0</div>
                </div>
                <div class="summary-item">
                    <div class="label">Trend</div>
                    <div class="value" id="summary-trend">‚Üí</div>
                    <div class="sub" id="summary-trend-text">Stabil</div>
                </div>
            </div>

            <!-- Form Curve -->
            <div class="form-curve" id="form-curve">
                <div class="form-curve-header">
                    <span class="form-curve-title">Formkurve (4 Wochen)</span>
                    <span class="form-status" id="form-status">Aufbau</span>
                </div>
                <div class="form-bars" id="form-bars"></div>
            </div>
        </div>

        <!-- Week Tabs -->
        <div class="week-tabs" id="week-tabs"></div>
    </div>

    <div class="content" id="workout-list"></div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="modal-import">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Plan Import</h2>
                <button class="modal-close" onclick="closeImport()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="toggle-group">
                    <button class="toggle-btn active" id="mode-replace" onclick="setImportMode('replace')">Ersetzen</button>
                    <button class="toggle-btn" id="mode-merge" onclick="setImportMode('merge')">Zusammenf√ºhren</button>
                </div>
                <div class="form-group">
                    <label class="form-label">JSON Daten</label>
                    <textarea class="form-input" id="import-text" placeholder='{"workouts": [...], "ftp": 185}'></textarea>
                </div>
                <button class="btn-primary" onclick="handleImport()">Importieren</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="modal-settings">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">FTP (Watt)</label>
                    <input type="number" class="form-input" id="settings-ftp" value="185">
                </div>
                
                <div class="divider"></div>
                
                <button class="btn-strava" id="strava-btn" onclick="connectStrava()">
                    üîó Mit Strava verbinden
                </button>
                <div class="strava-status" id="strava-status" style="display: none;"></div>
                
                <div class="divider"></div>
                
                <button class="btn-danger" onclick="resetData()">Alle Daten zur√ºcksetzen</button>
            </div>
        </div>
    </div>

    <!-- Log Workout Modal -->
    <div class="modal-overlay" id="modal-log">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Training loggen</h2>
                <button class="modal-close" onclick="closeLog()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="log-workout-header">
                    <div class="log-workout-title" id="log-title"></div>
                    <div class="log-workout-date" id="log-date"></div>
                </div>

                <!-- Strava Activity Selector -->
                <div class="strava-selector" id="strava-selector" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Strava-Aktivit√§t ausw√§hlen</label>
                        <button class="btn-load-strava" id="btn-load-strava" onclick="loadStravaActivitiesForLog()">
                            üîÑ Strava-Aktivit√§ten laden
                        </button>
                        <div class="strava-activities-list" id="strava-activities-list"></div>
                    </div>
                    <div class="divider"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dauer (min)</label>
                        <input type="number" class="form-input" id="log-duration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label class="form-label">√ò Leistung (W)</label>
                        <input type="number" class="form-input" id="log-power" placeholder="optional">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Normalisiert (NP)</label>
                        <input type="number" class="form-input" id="log-np" placeholder="optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Distanz (km)</label>
                        <input type="number" class="form-input" id="log-distance" placeholder="optional" step="0.1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">√ò Herzfrequenz</label>
                        <input type="number" class="form-input" id="log-avghr" placeholder="optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Herzfrequenz</label>
                        <input type="number" class="form-input" id="log-maxhr" placeholder="optional">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Kalorien</label>
                        <input type="number" class="form-input" id="log-calories" placeholder="optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">TSS</label>
                        <input type="number" class="form-input" id="log-tss" placeholder="optional">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Wie f√ºhlte es sich an?</label>
                    <div class="feeling-row" id="feeling-row">
                        <button class="feeling-btn" data-value="1">üò´</button>
                        <button class="feeling-btn" data-value="2">üòï</button>
                        <button class="feeling-btn" data-value="3">üòê</button>
                        <button class="feeling-btn" data-value="4">üôÇ</button>
                        <button class="feeling-btn active" data-value="5">üí™</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-input" id="log-notes" placeholder="Wie lief's? Intervalle geschafft?" style="min-height: 80px;"></textarea>
                </div>

                <button class="btn-primary" onclick="saveLog()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div class="modal-overlay" id="modal-edit">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Workout bearbeiten</h2>
                <button class="modal-close" onclick="closeEdit()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Datum</label>
                    <input type="date" class="form-input" id="edit-date">
                </div>

                <div class="form-group">
                    <label class="form-label">Titel</label>
                    <input type="text" class="form-input" id="edit-title">
                </div>

                <div class="form-group">
                    <label class="form-label">Dauer</label>
                    <input type="text" class="form-input" id="edit-duration" placeholder="z.B. 1h oder 90m">
                </div>

                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea class="form-input" id="edit-desc" style="min-height: 60px;"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Nutrition</label>
                    <textarea class="form-input" id="edit-nutrition" style="min-height: 60px;"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Coach-Notiz</label>
                    <textarea class="form-input" id="edit-coach-notes" placeholder="Anpassungshinweise vom AI Coach" style="min-height: 60px;"></textarea>
                </div>

                <button class="btn-primary" onclick="saveEdit()">Speichern</button>
                
                <div class="divider"></div>
                
                <button class="btn-danger" onclick="deleteWorkoutFromEdit()">üóë Workout l√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Plan Overview Modal -->
    <div class="modal-overlay" id="modal-plan">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gesamtplan</h2>
                <button class="modal-close" onclick="closePlanOverview()">‚úï</button>
            </div>
            <div class="modal-body" id="plan-body"></div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let workouts = [];
        let ftp = 185;
        let completed = {};
        let activityLogs = {};
        let selectedWeek = 0;
        let importMode = 'replace';
        let compactMode = false;
        let currentLogWorkoutId = null;
        let selectedFeeling = 5;
        let weatherCache = {};
        let headerCollapsed = false;

        // ============================================
        // STRAVA CONFIGURATION
        // ============================================
        const STRAVA_CLIENT_ID = '193172';
        const STRAVA_CLIENT_SECRET = '10ab0ddd492c66638cea82a80777e95db020c401';
        const STRAVA_REDIRECT_URI = window.location.origin + window.location.pathname;
        
        let stravaTokens = null;
        let stravaActivities = [];
        let stravaActivityForLog = null;

        // ============================================
        // INITIAL DATA
        // ============================================
        const initialWorkouts = [
            {
                id: '2025-12-30_sweetspot',
                date: '2025-12-30',
                title: 'Sweetspot & Torque Intro',
                duration: '1h',
                desc: 'Wir starten mit Kraftausdauer. Die niedrige Trittfrequenz simuliert die Muskelspannung am Berg.',
                intervals: '- 15m 50% Warmup\n- 2x 10m 88% 60rpm (5m 50% recovery)\n- 10m 50% Cooldown',
                nutrition: '1 Flasche Wasser mit 1.5 Scoops Power Carb (ca. 70g)',
                technique: 'Runder Tritt: Ziehe das Pedal aktiv hoch.',
                video_url: 'https://www.youtube.com/watch?v=pdl92_gIDhw',
                coach_notes: ''
            },
            {
                id: '2026-01-04_endurance',
                date: '2026-01-04',
                title: 'Endurance & Low Cadence',
                duration: '2.5h',
                desc: 'Grundlage mit Kraft-Einlagen. Bei 60rpm ruhig im Oberk√∂rper bleiben.',
                intervals: '- 20m 55%\n- 3x 10m 78% 60rpm (10m 55% R)\n- 80m 65% Endurance\n- 10m 50%',
                nutrition: 'Pro Stunde 1 Scoop Power Carb. Insg. 2.5 Scoops.',
                technique: 'Aerodynamik: Intervalle im Unterlenker.',
                video_url: 'https://www.youtube.com/watch?v=ldvFqQeKAFU',
                coach_notes: ''
            },
            {
                id: '2026-01-06_threshold',
                date: '2026-01-06',
                title: 'Threshold & RPM Contrast',
                duration: '1h',
                desc: 'Der Wechsel zwischen 60rpm und 95rpm bei gleicher Wattzahl schult die neuromuskul√§re Effizienz.',
                intervals: '- 15m 55% Warmup\n- 3x 8m 95% (4m 60rpm / 4m 95rpm)\n- 10m 50%',
                nutrition: 'High Carb: 60g Carbs.',
                technique: 'Kadenz-Kontrolle: Kein Wippen im Sattel.',
                video_url: 'https://www.youtube.com/watch?v=Tq_wdIXXKcY',
                coach_notes: ''
            },
            {
                id: '2026-01-11_gravel',
                date: '2026-01-11',
                title: 'Long Gravel Ride',
                duration: '3h',
                desc: 'Suche bewusst schlechte Wege. Sand und Matsch f√ºr mehr Balance.',
                intervals: '- 180m 60-70% FTP Free Ride\n- 5x kurze Sand-Passagen',
                nutrition: '3 Scoops Power Carb + 1 Riegel nach 1.5h.',
                technique: 'Sand: Gewicht hinten, leichter Gang.',
                video_url: 'https://www.youtube.com/watch?v=M5fqQFSgB2Q',
                coach_notes: ''
            },
            {
                id: '2026-01-13_vo2max',
                date: '2026-01-13',
                title: 'VO2max Micro-Bursts',
                duration: '1h',
                desc: 'Kurz und hart. 30/30 Intervalle f√ºr maximale Sauerstoffaufnahme.',
                intervals: '- 15m 50%\n- 2x 10m (30s 120% / 30s 50%)\n- 15m 50%',
                nutrition: 'Wasser mit Elektrolyten.',
                technique: 'Wiegetritt: Erste 5 Sek. im Stehen.',
                video_url: 'https://www.youtube.com/watch?v=bOIs8MfkCME',
                coach_notes: ''
            },
            {
                id: '2026-01-18_biggear',
                date: '2026-01-18',
                title: 'Big Gear Endurance',
                duration: '3h',
                desc: 'K√∂nigsetappe. Kette rechts! Lange, flache Anstiege simulieren.',
                intervals: '- 30m 60%\n- 4x 15m 80-85% 60rpm (10m R)\n- Rest 65%',
                nutrition: '80g Carbs pro Stunde testen.',
                technique: 'Bike-Body-Separation in Kurven.',
                video_url: 'https://www.youtube.com/watch?v=GF0LfwuK-rc',
                coach_notes: ''
            },
            {
                id: '2026-01-20_recovery',
                date: '2026-01-20',
                title: 'Recovery Spin',
                duration: '45m',
                desc: 'Erholung. Locker kurbeln, Beine aussch√ºtteln.',
                intervals: '- 45m 50-55% steady state',
                nutrition: 'Nur Wasser.',
                technique: 'Souplesse: Geschmeidig treten.',
                video_url: '',
                coach_notes: ''
            },
            {
                id: '2026-01-25_social',
                date: '2026-01-25',
                title: 'Social Ride',
                duration: '2h',
                desc: 'Spa√üfahrt. Kopf frei. Keine roten Bereiche.',
                intervals: '- 120m HR < 75% Max',
                nutrition: '1 Riegel Reserve.',
                technique: 'Blickf√ºhrung: Weit voraus schauen.',
                video_url: 'https://www.youtube.com/watch?v=t1Eqt6tZdw4',
                coach_notes: ''
            }
        ];

        // ============================================
        // HELPERS
        // ============================================
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            return `${days[date.getDay()]} ${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        function parseDuration(duration) {
            const match = duration.match(/(\d+\.?\d*)\s*(h|m|min)/i);
            if (!match) return 60;
            const value = parseFloat(match[1]);
            const unit = match[2].toLowerCase();
            return unit === 'h' ? value * 60 : value;
        }

        function formatDurationHours(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return m > 0 ? `${h}h ${m}m` : `${h}h`;
        }

        function getIntensityClass(title) {
            const t = title.toLowerCase();
            if (t.includes('recovery') || t.includes('social')) return 'recovery';
            if (t.includes('vo2') || t.includes('threshold')) return 'threshold';
            if (t.includes('endurance') || t.includes('gravel')) return 'endurance';
            return 'sweetspot';
        }

        function isToday(dateStr) {
            const today = new Date();
            const date = new Date(dateStr);
            return date.toDateString() === today.toDateString();
        }

        function isFutureDate(dateStr) {
            return new Date(dateStr) > new Date();
        }

        // ============================================
        // DATA PERSISTENCE
        // ============================================
        function loadData() {
            try {
                const w = localStorage.getItem('gravel-workouts');
                const f = localStorage.getItem('gravel-ftp');
                const c = localStorage.getItem('gravel-completed');
                const a = localStorage.getItem('gravel-activities');

                workouts = w ? JSON.parse(w) : initialWorkouts;
                ftp = f ? parseInt(f) : 185;
                completed = c ? JSON.parse(c) : {};
                activityLogs = a ? JSON.parse(a) : {};

                document.getElementById('ftp-display').textContent = ftp + 'W';
                document.getElementById('settings-ftp').value = ftp;
            } catch (e) {
                console.error('Load error:', e);
                workouts = initialWorkouts;
            }
        }

        function saveData() {
            try {
                localStorage.setItem('gravel-workouts', JSON.stringify(workouts));
                localStorage.setItem('gravel-ftp', String(ftp));
                localStorage.setItem('gravel-completed', JSON.stringify(completed));
                localStorage.setItem('gravel-activities', JSON.stringify(activityLogs));
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        // ============================================
        // WEEKS
        // ============================================
        function getWeeks() {
            if (workouts.length === 0) return [];
            const sorted = [...workouts].sort((a, b) => new Date(a.date) - new Date(b.date));
            const weeksMap = new Map();

            sorted.forEach(w => {
                const weekNum = getWeekNumber(new Date(w.date));
                const year = new Date(w.date).getFullYear();
                const key = `${year}-${weekNum}`;
                if (!weeksMap.has(key)) weeksMap.set(key, []);
                weeksMap.get(key).push(w);
            });

            return Array.from(weeksMap.values());
        }

        function findTodayWeek() {
            const weeks = getWeeks();
            const today = new Date();
            for (let i = 0; i < weeks.length; i++) {
                for (const w of weeks[i]) {
                    if (isToday(w.date)) return i;
                }
            }
            // Find closest future week
            for (let i = 0; i < weeks.length; i++) {
                for (const w of weeks[i]) {
                    if (new Date(w.date) >= today) return i;
                }
            }
            return 0;
        }

        // ============================================
        // WEEK SUMMARY
        // ============================================
        function updateWeekSummary() {
            const weeks = getWeeks();
            const currentWeekWorkouts = weeks[selectedWeek] || [];

            let targetMinutes = 0;
            let actualMinutes = 0;
            let completedCount = 0;

            currentWeekWorkouts.forEach(w => {
                targetMinutes += parseDuration(w.duration);
                if (completed[w.id]) {
                    completedCount++;
                    const log = activityLogs[w.id];
                    actualMinutes += log?.duration || parseDuration(w.duration);
                }
            });

            const percent = targetMinutes > 0 ? Math.round((actualMinutes / targetMinutes) * 100) : 0;

            document.getElementById('summary-target').textContent = formatDurationHours(targetMinutes);
            document.getElementById('summary-actual').textContent = formatDurationHours(actualMinutes);
            document.getElementById('summary-percent').textContent = percent + '%';
            document.getElementById('summary-percent').className = 'sub ' + (percent >= 90 ? 'trend-up' : percent >= 70 ? 'trend-neutral' : 'trend-down');
            document.getElementById('summary-completed').textContent = `${completedCount}/${currentWeekWorkouts.length}`;

            // Calculate trend vs previous week
            const prevWeekWorkouts = weeks[selectedWeek - 1] || [];
            let prevActual = 0;
            prevWeekWorkouts.forEach(w => {
                if (completed[w.id]) {
                    const log = activityLogs[w.id];
                    prevActual += log?.duration || parseDuration(w.duration);
                }
            });

            let trendIcon = '‚Üí';
            let trendText = 'Stabil';
            let trendClass = 'trend-neutral';

            if (prevActual > 0) {
                const diff = ((actualMinutes - prevActual) / prevActual) * 100;
                if (diff > 10) {
                    trendIcon = '‚Üë';
                    trendText = '+' + Math.round(diff) + '%';
                    trendClass = 'trend-up';
                } else if (diff < -10) {
                    trendIcon = '‚Üì';
                    trendText = Math.round(diff) + '%';
                    trendClass = 'trend-down';
                }
            }

            document.getElementById('summary-trend').textContent = trendIcon;
            document.getElementById('summary-trend').className = 'value ' + trendClass;
            document.getElementById('summary-trend-text').textContent = trendText;
        }

        // ============================================
        // FORM CURVE
        // ============================================
        function updateFormCurve() {
            const weeks = getWeeks();
            const container = document.getElementById('form-bars');
            container.innerHTML = '';

            // Calculate load for last 4 weeks relative to selected week
            const startIdx = Math.max(0, selectedWeek - 3);
            const weekLoads = [];

            for (let i = startIdx; i <= selectedWeek && i < weeks.length; i++) {
                let load = 0;
                weeks[i].forEach(w => {
                    if (completed[w.id]) {
                        const log = activityLogs[w.id];
                        load += log?.duration || parseDuration(w.duration);
                    }
                });
                weekLoads.push({
                    weekNum: getWeekNumber(new Date(weeks[i][0].date)),
                    load,
                    isCurrent: i === selectedWeek
                });
            }

            const maxLoad = Math.max(...weekLoads.map(w => w.load), 1);

            weekLoads.forEach(week => {
                const percent = (week.load / maxLoad) * 100;
                const wrapper = document.createElement('div');
                wrapper.className = 'form-bar-wrapper' + (week.isCurrent ? ' current' : '');
                wrapper.innerHTML = `
                    <div class="form-bar" style="height: 50px;">
                        <div class="form-bar-fill" style="height: ${Math.max(percent, 5)}%;"></div>
                    </div>
                    <span class="form-bar-label">KW${week.weekNum}</span>
                `;
                container.appendChild(wrapper);
            });

            // Determine form status
            const statusEl = document.getElementById('form-status');
            const currentLoad = weekLoads[weekLoads.length - 1]?.load || 0;
            const avgLoad = weekLoads.slice(0, -1).reduce((a, b) => a + b.load, 0) / Math.max(weekLoads.length - 1, 1);

            if (currentLoad < avgLoad * 0.7) {
                statusEl.textContent = 'Erholt';
                statusEl.className = 'form-status fresh';
            } else if (currentLoad > avgLoad * 1.3) {
                statusEl.textContent = '√úberlastung';
                statusEl.className = 'form-status overreaching';
            } else if (currentLoad > avgLoad * 1.1) {
                statusEl.textContent = 'Aufbau';
                statusEl.className = 'form-status building';
            } else {
                statusEl.textContent = 'Stabil';
                statusEl.className = 'form-status tired';
            }
        }

        // ============================================
        // WEATHER
        // ============================================
        let weatherFetchFailed = false;
        
        async function fetchWeather(dateStr) {
            // Skip if previous fetch failed (avoid repeated errors)
            if (weatherFetchFailed) return null;
            
            // Check cache
            if (weatherCache[dateStr]) return weatherCache[dateStr];

            try {
                // Using Open-Meteo API (free, no key required)
                // Bremen coordinates
                const lat = 53.0793;
                const lon = 8.8017;
                const date = new Date(dateStr);
                const today = new Date();
                const daysAhead = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

                // Only fetch for next 7 days
                if (daysAhead < 0 || daysAhead > 7) return null;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,precipitation_probability_max,weathercode&timezone=Europe/Berlin`,
                    { signal: controller.signal }
                );
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    weatherFetchFailed = true;
                    return null;
                }
                
                const data = await response.json();

                if (data.daily) {
                    for (let i = 0; i < data.daily.time.length; i++) {
                        const d = data.daily.time[i];
                        weatherCache[d] = {
                            temp: Math.round(data.daily.temperature_2m_max[i]),
                            rainProb: data.daily.precipitation_probability_max[i],
                            code: data.daily.weathercode[i]
                        };
                    }
                }

                return weatherCache[dateStr] || null;
            } catch (e) {
                // Silently fail - weather is optional
                weatherFetchFailed = true;
                return null;
            }
        }

        function getWeatherIcon(code) {
            // WMO Weather interpretation codes
            if (code <= 1) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return 'üå®Ô∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        function getWeatherWarning(weather) {
            if (!weather) return null;
            if (weather.rainProb > 70) return { type: 'rain', text: 'Hohe Regenwahrscheinlichkeit - Indoor-Alternative?' };
            if (weather.temp < 0) return { type: 'cold', text: 'Frost - Warm anziehen oder Indoor' };
            if (weather.temp > 30) return { type: 'heat', text: 'Hitze - Fr√ºh morgens fahren' };
            return null;
        }

        // ============================================
        // HEADER COLLAPSE
        // ============================================
        function toggleHeaderCollapse() {
            headerCollapsed = !headerCollapsed;
            const el = document.getElementById('header-collapsible');
            const btn = document.getElementById('btn-collapse');
            el.classList.toggle('collapsed', headerCollapsed);
            btn.classList.toggle('collapsed', headerCollapsed);
            localStorage.setItem('gravel-header-collapsed', headerCollapsed ? '1' : '0');
        }

        function loadHeaderCollapseState() {
            const saved = localStorage.getItem('gravel-header-collapsed');
            headerCollapsed = saved === '1';
            if (headerCollapsed) {
                document.getElementById('header-collapsible').classList.add('collapsed');
                document.getElementById('btn-collapse').classList.add('collapsed');
            }
        }

        // ============================================
        // CARD TABS
        // ============================================
        function switchCardTab(workoutId, tabId) {
            const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
            if (!card) return;
            card.querySelectorAll('.card-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
            card.querySelectorAll('.card-tab-content').forEach(c => c.classList.toggle('active', c.dataset.tab === tabId));
        }

        // ============================================
        // RENDER
        // ============================================
        function renderWeekTabs() {
            const weeks = getWeeks();
            const container = document.getElementById('week-tabs');
            container.innerHTML = '';

            weeks.forEach((week, idx) => {
                const weekNum = getWeekNumber(new Date(week[0].date));
                const completedCount = week.filter(w => completed[w.id]).length;
                const isActive = selectedWeek === idx;

                const tab = document.createElement('div');
                tab.className = 'week-tab' + (isActive ? ' active' : '');
                tab.innerHTML = `
                    <div class="week-num">KW ${weekNum}</div>
                    <div class="week-progress">${completedCount}/${week.length}</div>
                `;
                tab.onclick = () => {
                    selectedWeek = idx;
                    renderWeekTabs();
                    renderWorkouts();
                    updateWeekSummary();
                    updateFormCurve();
                };
                container.appendChild(tab);
            });
        }

        function buildComparisonHtml(workout, log) {
            if (!log) return '';
            const sollDuration = parseDuration(workout.duration);
            const istDuration = log.duration || sollDuration;
            const percent = Math.round((istDuration / sollDuration) * 100);
            const percentClass = percent >= 90 ? 'good' : 'warn';

            return `
                <div class="comparison-box">
                    <div class="comparison-title">
                        Soll-Ist Vergleich
                        ${log.stravaActivity ? '<span class="strava-badge">STRAVA</span>' : ''}
                    </div>
                    <div class="comparison-grid">
                        <div class="comparison-item">
                            <div class="label">Dauer</div>
                            <div class="value">${istDuration}m / ${sollDuration}m</div>
                            <div class="diff ${percentClass}">${percent}%</div>
                        </div>
                        ${log.avgPower ? `
                        <div class="comparison-item">
                            <div class="label">√ò Leistung</div>
                            <div class="value">${log.avgPower}W</div>
                            <div class="diff">${Math.round((log.avgPower / ftp) * 100)}% FTP</div>
                        </div>
                        ` : ''}
                        ${log.normalizedPower ? `
                        <div class="comparison-item">
                            <div class="label">NP</div>
                            <div class="value">${log.normalizedPower}W</div>
                            <div class="diff">${Math.round((log.normalizedPower / ftp) * 100)}% FTP</div>
                        </div>
                        ` : ''}
                    </div>
                    ${(log.distance || log.avgHr || log.calories) ? `
                    <div class="comparison-grid" style="margin-top: 10px;">
                        ${log.distance ? `
                        <div class="comparison-item">
                            <div class="label">Distanz</div>
                            <div class="value">${log.distance} km</div>
                        </div>
                        ` : ''}
                        ${log.avgHr ? `
                        <div class="comparison-item">
                            <div class="label">√ò HR</div>
                            <div class="value">${log.avgHr} bpm</div>
                            ${log.maxHr ? `<div class="diff">Max: ${log.maxHr}</div>` : ''}
                        </div>
                        ` : ''}
                        ${log.calories ? `
                        <div class="comparison-item">
                            <div class="label">Kalorien</div>
                            <div class="value">${log.calories} kcal</div>
                            ${log.tss ? `<div class="diff">TSS: ${log.tss}</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    <div class="comparison-feeling">
                        <span class="label">Gef√ºhl:</span> ${'‚≠ê'.repeat(log.feeling || 3)}
                    </div>
                    ${log.notes ? `<div class="comparison-notes">${log.notes}</div>` : ''}
                </div>
            `;
        }

        function buildWeatherHtml(weather, weatherWarning, isCompleted) {
            if (!weather || isCompleted) return '';
            const warning = weatherWarning;
            return `
                <div class="weather-alert ${warning ? 'has-warning' : 'good'}">
                    <span class="weather-icon">${getWeatherIcon(weather.code)}</span>
                    <div class="weather-info">
                        <div class="weather-temp">${weather.temp}¬∞C | ${weather.rainProb}% Regen</div>
                        ${warning ? `<div class="weather-desc">${warning.text}</div>` : '<div class="weather-desc weather-good">Gute Bedingungen</div>'}
                    </div>
                </div>
            `;
        }

        function renderHeroWorkout(workout, container) {
            const isComp = completed[workout.id];
            const log = activityLogs[workout.id];
            const intensityClass = getIntensityClass(workout.title);
            const comparisonHtml = buildComparisonHtml(workout, log);

            const hero = document.createElement('div');
            hero.className = 'hero-workout' + (isComp ? ' completed' : '');

            hero.innerHTML = `
                <div class="hero-label">Heute dran</div>
                <div class="hero-body">
                    <div class="hero-title">${workout.title}</div>
                    <div class="hero-meta">
                        <span class="hero-duration">${workout.duration}</span>
                        <span class="hero-intensity ${intensityClass}">${intensityClass}</span>
                    </div>
                    <p class="hero-desc">${workout.desc}</p>
                    ${workout.intervals ? `
                    <div class="intervals-box">
                        <pre class="intervals-text">${workout.intervals}</pre>
                    </div>
                    ` : ''}
                    ${comparisonHtml}
                    <div class="hero-actions">
                        <button class="btn-edit" onclick="openEdit('${workout.id}')" style="width:auto;height:auto;padding:10px 16px;border-radius:24px;font-size:12px;">‚úé Bearbeiten</button>
                        ${!isComp ? `<button class="btn-action btn-log" onclick="openLog('${workout.id}')">Training loggen</button>` : ''}
                        <button class="btn-action btn-complete ${isComp ? 'active' : ''}" onclick="toggleComplete('${workout.id}')" style="margin-left:auto;">
                            ${isComp ? '‚úì Erledigt' : 'Erledigt'}
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(hero);
        }

        async function renderWorkoutCard(workout, allWorkouts, container, index) {
            const isCompleted = completed[workout.id];
            const isTodayWorkout = isToday(workout.date);
            const log = activityLogs[workout.id];
            const intensityClass = getIntensityClass(workout.title);
            const weather = await fetchWeather(workout.date);
            const weatherWarning = getWeatherWarning(weather);

            const comparisonHtml = buildComparisonHtml(workout, log);
            const weatherHtml = buildWeatherHtml(weather, weatherWarning, isCompleted);

            // Build tabs for sections that have content
            const tabs = [];
            if (workout.intervals) tabs.push({ id: 'intervals', label: 'Intervalle', cls: 'tab-intervals' });
            if (workout.nutrition) tabs.push({ id: 'nutrition', label: 'Nutrition', cls: 'tab-nutrition' });
            if (workout.technique) tabs.push({ id: 'technique', label: 'Technik', cls: 'tab-technique' });
            if (workout.coach_notes) tabs.push({ id: 'coach', label: 'Coach', cls: 'tab-coach' });

            const hasTabs = tabs.length > 0;
            const firstTabId = hasTabs ? tabs[0].id : '';

            // Tab bar HTML
            let tabBarHtml = '';
            if (hasTabs) {
                tabBarHtml = `<div class="card-tabs">${tabs.map(t =>
                    `<button class="card-tab ${t.cls}${t.id === firstTabId ? ' active' : ''}" data-tab="${t.id}" onclick="switchCardTab('${workout.id}','${t.id}')">${t.label}</button>`
                ).join('')}</div>`;
            }

            // Tab content HTML
            let tabContentHtml = '';
            if (workout.intervals) {
                tabContentHtml += `<div class="card-tab-content card-body-tabbed${firstTabId === 'intervals' ? ' active' : ''}" data-tab="intervals">
                    <div class="intervals-box"><pre class="intervals-text">${workout.intervals}</pre></div>
                </div>`;
            }
            if (workout.nutrition) {
                tabContentHtml += `<div class="card-tab-content card-body-tabbed${firstTabId === 'nutrition' ? ' active' : ''}" data-tab="nutrition">
                    <div class="info-box nutrition"><div class="info-label">Nutrition</div><div class="info-text">${workout.nutrition}</div></div>
                </div>`;
            }
            if (workout.technique) {
                tabContentHtml += `<div class="card-tab-content card-body-tabbed${firstTabId === 'technique' ? ' active' : ''}" data-tab="technique">
                    <div class="info-box technique"><div class="info-label">Technik</div><div class="info-text">${workout.technique}</div>${workout.video_url ? `<a href="${workout.video_url}" target="_blank" class="btn-video">‚ñ∂ Video</a>` : ''}</div>
                </div>`;
            }
            if (workout.coach_notes) {
                tabContentHtml += `<div class="card-tab-content card-body-tabbed${firstTabId === 'coach' ? ' active' : ''}" data-tab="coach">
                    <div class="info-box coach-notes"><div class="info-label">Coach Notiz</div><div class="info-text">${workout.coach_notes}</div></div>
                </div>`;
            }

            const card = document.createElement('div');
            card.className = 'workout-card' +
                (isCompleted ? ' completed' : '') +
                (isTodayWorkout ? ' is-today' : '') +
                (compactMode ? ' compact-view' : '');
            card.style.animationDelay = `${index * 0.05}s`;
            card.dataset.workoutId = workout.id;

            card.innerHTML = `
                <div class="card-header">
                    <div class="intensity-bar ${intensityClass}"></div>
                    <div class="card-header-content">
                        <div class="card-header-left">
                            <div class="card-date-row">
                                <span class="card-date">${formatDate(workout.date)}</span>
                                ${isTodayWorkout ? '<span class="today-badge">Heute</span>' : ''}
                            </div>
                            <div class="card-title">${workout.title}</div>
                        </div>
                        <div class="card-header-right">
                            <span class="card-duration">${workout.duration}</span>
                            <button class="btn-edit" onclick="openEdit('${workout.id}')">‚úé</button>
                        </div>
                    </div>
                </div>

                <div class="card-body full">
                    <div class="card-body-always">
                        <p class="card-desc">${workout.desc}</p>
                        ${weatherHtml}
                        ${comparisonHtml}
                    </div>
                    ${tabBarHtml}
                    ${tabContentHtml}
                    <div class="card-actions" style="margin: 0 14px; padding: 14px 0;">
                        <div class="card-actions-right" style="margin-left: auto;">
                            ${!isCompleted ? `<button class="btn-action btn-log" onclick="openLog('${workout.id}')">Training loggen</button>` : ''}
                            <button class="btn-action btn-complete ${isCompleted ? 'active' : ''}" onclick="toggleComplete('${workout.id}')">
                                ${isCompleted ? '‚úì Erledigt' : 'Erledigt'}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body compact">
                    <span class="compact-status">${isCompleted ? '‚úì Erledigt' : ''}</span>
                    <div class="compact-actions">
                        ${!isCompleted ? `<button class="btn-action btn-log" onclick="openLog('${workout.id}')">Loggen</button>` : ''}
                        <button class="btn-action btn-complete ${isCompleted ? 'active' : ''}" onclick="toggleComplete('${workout.id}')">
                            ${isCompleted ? '‚úì' : '‚óã'}
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(card);
        }

        async function renderWorkouts() {
            const weeks = getWeeks();
            const currentWeekWorkouts = weeks[selectedWeek] || [];
            const container = document.getElementById('workout-list');

            if (currentWeekWorkouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üö¥</div>
                        <div class="empty-text">Keine Workouts in dieser Woche</div>
                        <div class="empty-link" onclick="openImport()">Plan importieren</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            // Find today's workout for hero rendering
            const todayWorkout = !compactMode ? currentWeekWorkouts.find(w => isToday(w.date)) : null;

            // Render hero if there's a today workout
            if (todayWorkout) {
                renderHeroWorkout(todayWorkout, container);
            }

            // Render remaining cards (skip today's workout if hero was rendered)
            let cardIndex = 0;
            for (const workout of currentWeekWorkouts) {
                if (todayWorkout && workout.id === todayWorkout.id) continue;
                await renderWorkoutCard(workout, currentWeekWorkouts, container, cardIndex++);
            }
        }

        // ============================================
        // ACTIONS
        // ============================================
        let currentEditWorkoutId = null;

        function openEdit(id) {
            currentEditWorkoutId = id;
            const workout = workouts.find(w => w.id === id);
            
            document.getElementById('edit-date').value = workout.date;
            document.getElementById('edit-title').value = workout.title;
            document.getElementById('edit-duration').value = workout.duration;
            document.getElementById('edit-desc').value = workout.desc || '';
            document.getElementById('edit-nutrition').value = workout.nutrition || '';
            document.getElementById('edit-coach-notes').value = workout.coach_notes || '';
            
            document.getElementById('modal-edit').classList.add('active');
        }

        function closeEdit() {
            document.getElementById('modal-edit').classList.remove('active');
            currentEditWorkoutId = null;
        }

        function saveEdit() {
            if (!currentEditWorkoutId) return;
            
            const newDate = document.getElementById('edit-date').value;
            const newTitle = document.getElementById('edit-title').value;
            const newDuration = document.getElementById('edit-duration').value;
            const newDesc = document.getElementById('edit-desc').value;
            const newNutrition = document.getElementById('edit-nutrition').value;
            const newCoachNotes = document.getElementById('edit-coach-notes').value;
            
            // Update workout
            workouts = workouts.map(w => {
                if (w.id === currentEditWorkoutId) {
                    return {
                        ...w,
                        date: newDate,
                        title: newTitle,
                        duration: newDuration,
                        desc: newDesc,
                        nutrition: newNutrition,
                        coach_notes: newCoachNotes
                    };
                }
                return w;
            });
            
            saveData();
            closeEdit();
            renderWeekTabs();
            renderWorkouts();
            updateWeekSummary();
            updateFormCurve();
        }

        function deleteWorkoutFromEdit() {
            if (currentEditWorkoutId) {
                deleteWorkout(currentEditWorkoutId);
                closeEdit();
            }
        }

        // ============================================
        // PLAN OVERVIEW
        // ============================================
        function openPlanOverview() {
            const weeks = getWeeks();
            const body = document.getElementById('plan-body');

            if (weeks.length === 0) {
                body.innerHTML = '<div class="plan-empty">Kein Trainingsplan geladen.<br>Importiere einen Plan √ºber den Ôºã Button.</div>';
                document.getElementById('modal-plan').classList.add('active');
                return;
            }

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const currentWeekNum = getWeekNumber(today);
            const currentYear = today.getFullYear();

            let html = '';
            weeks.forEach((week, idx) => {
                const weekDate = new Date(week[0].date);
                const weekNum = getWeekNumber(weekDate);
                const weekYear = weekDate.getFullYear();
                const isCurrent = weekNum === currentWeekNum && weekYear === currentYear;
                const completedCount = week.filter(w => completed[w.id]).length;

                let targetMin = 0;
                week.forEach(w => {
                    const d = w.duration || '';
                    const hMatch = d.match(/(\d+)\s*h/);
                    const mMatch = d.match(/(\d+)\s*m/);
                    targetMin += (hMatch ? parseInt(hMatch[1]) * 60 : 0) + (mMatch ? parseInt(mMatch[1]) : 0);
                });
                const targetH = Math.round(targetMin / 60 * 10) / 10;

                html += `<div class="plan-week${isCurrent ? ' current' : ''}">`;
                html += `<div class="plan-week-header">`;
                html += `<span>KW ${weekNum} ¬∑ ${targetH}h</span>`;
                html += `<span class="plan-week-progress">${completedCount}/${week.length} erledigt</span>`;
                html += `</div>`;

                week.forEach(w => {
                    const isDone = completed[w.id];
                    const isTodayWorkout = w.date === todayStr;
                    const intensity = getIntensityClass(w.title);
                    const rowClasses = ['plan-workout-row'];
                    if (isDone) rowClasses.push('completed');
                    if (isTodayWorkout) rowClasses.push('is-today');

                    html += `<div class="${rowClasses.join(' ')}" onclick="navigateToWeek(${idx})">`;
                    html += `<span class="plan-dot ${intensity}"></span>`;
                    html += `<span class="plan-workout-date">${formatDate(w.date)}</span>`;
                    html += `<span class="plan-workout-title">${w.title}</span>`;
                    html += `<span class="plan-workout-duration">${w.duration || ''}</span>`;
                    html += `<span class="plan-workout-status">${isDone ? '‚úì' : ''}</span>`;
                    html += `</div>`;
                });

                html += `</div>`;
            });

            body.innerHTML = html;
            document.getElementById('modal-plan').classList.add('active');
        }

        function closePlanOverview() {
            document.getElementById('modal-plan').classList.remove('active');
        }

        function navigateToWeek(idx) {
            closePlanOverview();
            selectedWeek = idx;
            renderWeekTabs();
            renderWorkouts();
            updateWeekSummary();
            updateFormCurve();
        }

        function toggleComplete(id) {
            completed[id] = !completed[id];
            saveData();
            renderWorkouts();
            renderWeekTabs();
            updateWeekSummary();
            updateFormCurve();
        }

        function deleteWorkout(id) {
            if (confirm('Workout wirklich l√∂schen?')) {
                workouts = workouts.filter(w => w.id !== id);
                delete completed[id];
                delete activityLogs[id];
                saveData();
                renderWorkouts();
                renderWeekTabs();
                updateWeekSummary();
                updateFormCurve();
            }
        }

        function toggleCompactMode() {
            compactMode = !compactMode;
            document.getElementById('btn-compact').classList.toggle('active', compactMode);
            renderWorkouts();
        }

        // ============================================
        // MODALS
        // ============================================
        function openImport() {
            document.getElementById('modal-import').classList.add('active');
        }

        function closeImport() {
            document.getElementById('modal-import').classList.remove('active');
        }

        function setImportMode(mode) {
            importMode = mode;
            document.getElementById('mode-replace').classList.toggle('active', mode === 'replace');
            document.getElementById('mode-merge').classList.toggle('active', mode === 'merge');
        }

        function handleImport() {
            const text = document.getElementById('import-text').value;
            try {
                const data = JSON.parse(text);
                let imported;

                if (data.ftp) ftp = data.ftp;
                imported = data.workouts || data;

                if (importMode === 'replace') {
                    workouts = imported;
                } else {
                    const existingMap = new Map(workouts.map(w => [w.id, w]));
                    imported.forEach(w => existingMap.set(w.id, w));
                    workouts = Array.from(existingMap.values());
                }

                document.getElementById('ftp-display').textContent = ftp + 'W';
                document.getElementById('settings-ftp').value = ftp;

                saveData();
                selectedWeek = findTodayWeek();
                renderWeekTabs();
                renderWorkouts();
                updateWeekSummary();
                updateFormCurve();
                closeImport();
                document.getElementById('import-text').value = '';

                alert(`${imported.length} Workouts importiert`);
            } catch (e) {
                alert('JSON-Fehler: ' + e.message);
            }
        }

        function openSettings() {
            document.getElementById('modal-settings').classList.add('active');
        }

        function closeSettings() {
            const newFtp = parseInt(document.getElementById('settings-ftp').value) || 185;
            ftp = newFtp;
            document.getElementById('ftp-display').textContent = ftp + 'W';
            saveData();
            document.getElementById('modal-settings').classList.remove('active');
        }

        function connectStrava() {
            const scope = 'read,activity:read_all';
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CLIENT_ID}&redirect_uri=${encodeURIComponent(STRAVA_REDIRECT_URI)}&response_type=code&scope=${scope}`;
            window.location.href = authUrl;
        }

        function disconnectStrava() {
            if (confirm('Strava-Verbindung trennen?')) {
                localStorage.removeItem('strava-tokens');
                stravaTokens = null;
                updateStravaUI();
            }
        }

        function loadStravaTokens() {
            try {
                const stored = localStorage.getItem('strava-tokens');
                if (stored) {
                    stravaTokens = JSON.parse(stored);
                    if (stravaTokens.expires_at && stravaTokens.expires_at < Date.now() / 1000) {
                        refreshStravaToken();
                    }
                }
            } catch (e) {
                console.error('Error loading Strava tokens:', e);
            }
        }

        function saveStravaTokens(tokens) {
            stravaTokens = tokens;
            localStorage.setItem('strava-tokens', JSON.stringify(tokens));
        }

        async function handleStravaCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                alert('Strava-Autorisierung fehlgeschlagen: ' + error);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (code) {
                try {
                    const response = await fetch('https://www.strava.com/oauth/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: STRAVA_CLIENT_ID,
                            client_secret: STRAVA_CLIENT_SECRET,
                            code: code,
                            grant_type: 'authorization_code'
                        })
                    });

                    if (!response.ok) throw new Error('Token exchange failed');

                    const tokens = await response.json();
                    saveStravaTokens(tokens);
                    updateStravaUI();
                    alert('Strava erfolgreich verbunden!');
                } catch (e) {
                    alert('Fehler bei Strava-Verbindung: ' + e.message);
                }
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function refreshStravaToken() {
            if (!stravaTokens?.refresh_token) return false;

            try {
                const response = await fetch('https://www.strava.com/oauth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: STRAVA_CLIENT_ID,
                        client_secret: STRAVA_CLIENT_SECRET,
                        refresh_token: stravaTokens.refresh_token,
                        grant_type: 'refresh_token'
                    })
                });

                if (!response.ok) throw new Error('Token refresh failed');

                const tokens = await response.json();
                saveStravaTokens(tokens);
                return true;
            } catch (e) {
                console.error('Error refreshing token:', e);
                return false;
            }
        }

        function isStravaConnected() {
            return stravaTokens && stravaTokens.access_token;
        }

        function updateStravaUI() {
            const btn = document.getElementById('strava-btn');
            const status = document.getElementById('strava-status');
            
            if (isStravaConnected()) {
                btn.innerHTML = 'üîì Strava trennen';
                btn.onclick = disconnectStrava;
                btn.classList.add('connected');
                if (status) {
                    status.textContent = `Verbunden als ${stravaTokens.athlete?.firstname || 'Athlet'}`;
                    status.style.display = 'block';
                }
            } else {
                btn.innerHTML = 'üîó Mit Strava verbinden';
                btn.onclick = connectStrava;
                btn.classList.remove('connected');
                if (status) {
                    status.style.display = 'none';
                }
            }
        }

        async function fetchStravaActivities() {
            if (!isStravaConnected()) return [];

            if (stravaTokens.expires_at && stravaTokens.expires_at < Date.now() / 1000) {
                const refreshed = await refreshStravaToken();
                if (!refreshed) return [];
            }

            try {
                const response = await fetch(
                    'https://www.strava.com/api/v3/athlete/activities?per_page=30',
                    { headers: { 'Authorization': `Bearer ${stravaTokens.access_token}` } }
                );

                if (!response.ok) {
                    if (response.status === 401) {
                        await refreshStravaToken();
                        return fetchStravaActivities();
                    }
                    throw new Error('Failed to fetch activities');
                }

                const activities = await response.json();
                return activities.map(formatStravaActivity);
            } catch (e) {
                console.error('Error fetching Strava activities:', e);
                return [];
            }
        }

        function formatStravaActivity(activity) {
            const date = new Date(activity.start_date_local);
            const duration = Math.round(activity.moving_time / 60);
            const distance = (activity.distance / 1000).toFixed(1);
            
            return {
                id: activity.id,
                name: activity.name,
                date: date.toISOString().split('T')[0],
                dateFormatted: formatDate(date.toISOString().split('T')[0]),
                duration: duration,
                distance: distance,
                avgPower: activity.average_watts || 0,
                normalizedPower: activity.weighted_average_watts || 0,
                avgHr: activity.average_heartrate || 0,
                maxHr: activity.max_heartrate || 0,
                calories: activity.calories || 0,
                tss: activity.suffer_score || 0,
                type: activity.type
            };
        }

        function resetData() {
            if (confirm('Wirklich alle Daten l√∂schen?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function openLog(id) {
            currentLogWorkoutId = id;
            stravaActivityForLog = null;
            const workout = workouts.find(w => w.id === id);
            const existingLog = activityLogs[id];

            document.getElementById('log-title').textContent = workout.title;
            document.getElementById('log-date').textContent = formatDate(workout.date);
            document.getElementById('log-duration').value = existingLog?.duration || parseDuration(workout.duration);
            document.getElementById('log-power').value = existingLog?.avgPower || '';
            document.getElementById('log-np').value = existingLog?.normalizedPower || '';
            document.getElementById('log-distance').value = existingLog?.distance || '';
            document.getElementById('log-avghr').value = existingLog?.avgHr || '';
            document.getElementById('log-maxhr').value = existingLog?.maxHr || '';
            document.getElementById('log-calories').value = existingLog?.calories || '';
            document.getElementById('log-tss').value = existingLog?.tss || '';
            document.getElementById('log-notes').value = existingLog?.notes || '';

            selectedFeeling = existingLog?.feeling || 5;
            updateFeelingButtons();

            // Show/hide Strava selector
            const stravaSelector = document.getElementById('strava-selector');
            const activitiesList = document.getElementById('strava-activities-list');
            if (isStravaConnected()) {
                stravaSelector.style.display = 'block';
                activitiesList.innerHTML = '';
            } else {
                stravaSelector.style.display = 'none';
            }

            document.getElementById('modal-log').classList.add('active');
        }

        async function loadStravaActivitiesForLog() {
            const btn = document.getElementById('btn-load-strava');
            const list = document.getElementById('strava-activities-list');
            
            btn.classList.add('loading');
            btn.textContent = '‚è≥ Laden...';
            
            const activities = await fetchStravaActivities();
            
            btn.classList.remove('loading');
            btn.textContent = 'üîÑ Strava-Aktivit√§ten laden';
            
            if (activities.length === 0) {
                list.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 12px;">Keine Aktivit√§ten gefunden</div>';
                return;
            }

            // Filter to only show cycling activities
            const cyclingActivities = activities.filter(a => 
                a.type === 'Ride' || a.type === 'VirtualRide' || a.type === 'GravelRide' || a.type === 'MountainBikeRide'
            );

            list.innerHTML = cyclingActivities.map(activity => `
                <div class="strava-activity-item" onclick="selectStravaActivity(${activity.id}, '${activity.name.replace(/'/g, "\\'")}', ${activity.duration}, ${activity.avgPower}, ${activity.normalizedPower}, ${activity.distance}, ${activity.avgHr}, ${activity.maxHr}, ${activity.calories}, ${activity.tss})">
                    <div class="strava-activity-name">${activity.name}</div>
                    <div class="strava-activity-meta">
                        <span>üìÖ ${activity.dateFormatted}</span>
                        <span>‚è±Ô∏è ${activity.duration}min</span>
                        <span>üìè ${activity.distance}km</span>
                        ${activity.avgPower ? `<span>‚ö° ${activity.avgPower}W</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function selectStravaActivity(id, name, duration, avgPower, np, distance, avgHr, maxHr, calories, tss) {
            // Remove previous selection
            document.querySelectorAll('.strava-activity-item').forEach(el => el.classList.remove('selected'));
            
            // Mark selected
            event.currentTarget.classList.add('selected');
            
            // Fill form fields
            document.getElementById('log-duration').value = duration || '';
            document.getElementById('log-power').value = avgPower || '';
            document.getElementById('log-np').value = np || '';
            document.getElementById('log-distance').value = distance || '';
            document.getElementById('log-avghr').value = avgHr || '';
            document.getElementById('log-maxhr').value = maxHr || '';
            document.getElementById('log-calories').value = calories || '';
            document.getElementById('log-tss').value = tss || '';
            
            stravaActivityForLog = { id, name };
        }

        function closeLog() {
            document.getElementById('modal-log').classList.remove('active');
            currentLogWorkoutId = null;
        }

        function updateFeelingButtons() {
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                const val = parseInt(btn.dataset.value);
                btn.classList.toggle('active', val <= selectedFeeling);
            });
        }

        function saveLog() {
            if (!currentLogWorkoutId) return;

            activityLogs[currentLogWorkoutId] = {
                duration: parseInt(document.getElementById('log-duration').value) || 60,
                avgPower: parseInt(document.getElementById('log-power').value) || 0,
                normalizedPower: parseInt(document.getElementById('log-np').value) || 0,
                distance: parseFloat(document.getElementById('log-distance').value) || 0,
                avgHr: parseInt(document.getElementById('log-avghr').value) || 0,
                maxHr: parseInt(document.getElementById('log-maxhr').value) || 0,
                calories: parseInt(document.getElementById('log-calories').value) || 0,
                tss: parseInt(document.getElementById('log-tss').value) || 0,
                feeling: selectedFeeling,
                notes: document.getElementById('log-notes').value,
                stravaActivity: stravaActivityForLog,
                loggedAt: new Date().toISOString()
            };

            completed[currentLogWorkoutId] = true;
            saveData();
            closeLog();
            renderWorkouts();
            renderWeekTabs();
            updateWeekSummary();
            updateFormCurve();
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadStravaTokens();
            handleStravaCallback();
            loadHeaderCollapseState();
            
            selectedWeek = findTodayWeek();
            renderWeekTabs();
            renderWorkouts();
            updateWeekSummary();
            updateFormCurve();
            updateStravaUI();

            // Feeling buttons
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                btn.onclick = () => {
                    selectedFeeling = parseInt(btn.dataset.value);
                    updateFeelingButtons();
                };
            });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                };
            });
        });
    </script>
</body>
</html>
