<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravel Coach Sync</title>
    
    <link rel="icon" type="image/png" href="Icon.png">
    <link rel="apple-touch-icon" href="Icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1A2233">

    <style>
        :root {
            --bg: #F4F6F8; --card-bg: #ffffff; --header-bg: #1A2233;
            --accent-orange: #D69E68; --accent-red-bg: #FFF0F0; --accent-red-text: #D32F2F;
            --code-bg: #0F172A; --code-text: #4ADE80; --text-main: #333; --text-sub: #666;
            --tech-bg: #F0F4FF; --tech-border: #4A90E2;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #121212; --card-bg: #1E1E1E; --header-bg: #2C3E50;
                --accent-red-bg: #2D1A1A; --accent-red-text: #FF8A80;
                --text-main: #eee; --text-sub: #aaa; --tech-bg: #1A2634;
            }
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text-main);
            margin: 0; padding: 15px; padding-bottom: 80px; overscroll-behavior-y: none;
        }

        header { margin-bottom: 20px; }
        h1 { font-size: 1.5em; margin: 0 0 5px 0; color: var(--text-main); }
        h1 span { color: var(--accent-orange); font-size: 0.6em; vertical-align: middle; background: rgba(214, 158, 104, 0.1); padding: 2px 6px; border-radius: 4px; }
        .sub-header { font-size: 0.9em; color: var(--text-sub); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;}

        .status-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .status-dot.online { background-color: #4ADE80; box-shadow: 0 0 5px #4ADE80; }
        .status-dot.error { background-color: #D32F2F; }

        .stats-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .badge-box { background: var(--card-bg); border: 1px solid rgba(0,0,0,0.1); padding: 8px 12px; border-radius: 8px; text-align: center; min-width: 80px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .badge-label { font-size: 0.7em; color: #999; text-transform: uppercase; font-weight: bold; }
        .badge-val { font-size: 1.1em; font-weight: 800; color: var(--text-main); margin-top: 2px; }
        .badge-red { color: #D32F2F; }

        .tabs-container { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; scrollbar-width: none; }
        .tab { background: var(--card-bg); color: var(--text-sub); padding: 10px 20px; border-radius: 20px; font-weight: 600; font-size: 0.9em; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .tab.active { background: var(--accent-orange); color: #fff; box-shadow: 0 4px 10px rgba(214, 158, 104, 0.4); }

        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 25px; transition: opacity 0.3s; }
        .card.done { opacity: 0.6; filter: grayscale(0.8); }
        .card-header { background: var(--header-bg); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* DATE EDIT STYLES */
        .date-wrapper { position: relative; display: inline-block; }
        .date-badge { background: var(--accent-orange); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-right: 10px; cursor: pointer; display: inline-flex; align-items: center; }
        .date-badge::after { content: '✎'; font-size: 0.8em; margin-left: 5px; opacity: 0.7; }
        .date-input { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        .card-title { color: #fff; font-weight: 700; font-size: 1.1em; flex-grow: 1; }
        .card-duration { color: rgba(255,255,255,0.7); font-weight: bold; font-size: 0.9em; }
        .card-body { padding: 15px; }
        .description { margin-bottom: 15px; line-height: 1.5; font-size: 0.95em; }

        .code-container { background: var(--code-bg); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .code-text { font-family: 'Courier New', monospace; color: var(--code-text); font-size: 0.85em; line-height: 1.4; white-space: pre-wrap; margin: 0; }

        .info-box { background: var(--accent-red-bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--accent-red-text); }
        .info-label { color: var(--accent-red-text); font-size: 0.7em; font-weight: bold; letter-spacing: 1px; margin-bottom: 4px; text-transform: uppercase; }
        .info-text { font-size: 0.9em; line-height: 1.4; color: var(--text-main); }
        .tech-box { background: var(--tech-bg); border-left-color: var(--tech-border); }
        .tech-box .info-label { color: var(--tech-border); }
        .video-btn { display: inline-block; margin-top: 8px; background: #ff0000; color: white; text-decoration: none; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; position:relative; z-index:20;}

        .action-row { display: flex; justify-content: flex-end; margin-top: 10px; }
        .done-btn { background: transparent; border: 2px solid #ddd; padding: 8px 16px; border-radius: 20px; color: var(--text-sub); font-weight: 600; cursor: pointer; }
        .done-btn.active { background: var(--accent-orange); border-color: var(--accent-orange); color: white; }

        .fab { position: fixed; top: 15px; right: 15px; background: rgba(255,255,255,0.9); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 1.2em; z-index: 90; cursor: pointer; }
    </style>
</head>
<body>

    <div class="fab" onclick="location.reload()">↻</div>

    <header>
        <h1>Ultra Gravel <span>SYNC</span></h1>
        <div class="sub-header">
            <span id="status-dot" class="status-dot"></span>
            <span id="status-text" style="margin-left: 8px;">Lade Plan...</span>
        </div>

        <div class="stats-row">
            <div class="badge-box"><div class="badge-label">FTP</div><div class="badge-val">185W</div></div>
            <div class="badge-box"><div class="badge-label">KRAFT</div><div class="badge-val">Milon 2x</div></div>
            <div class="badge-box"><div class="badge-label">CARBS</div><div class="badge-val badge-red">MNSTRY</div></div>
        </div>
    </header>

    <div class="tabs-container" id="week-tabs"></div>
    <div id="workout-list"></div>

    <script>
        let workouts = [];
        let activeWeek = "Woche 1";
        
        // Lokale Speicher:
        let progressData = {}; // Speichert: "ID": true (Erledigt)
        let dateOverrides = {}; // Speichert: "ID": "2024-01-05" (Neues Datum)

        async function init() {
            loadLocalData();
            await fetchPlanFromGitHub();
        }

        function loadLocalData() {
            // Status laden
            const storedProgress = localStorage.getItem('gravelProgress');
            if(storedProgress) { try { progressData = JSON.parse(storedProgress); } catch(e) {} }
            
            // Datum Änderungen laden
            const storedDates = localStorage.getItem('gravelDates');
            if(storedDates) { try { dateOverrides = JSON.parse(storedDates); } catch(e) {} }
        }

        async function fetchPlanFromGitHub() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            try {
                // Cache-Busting mit Timestamp
                const response = await fetch('training.json?t=' + new Date().getTime());
                if (!response.ok) throw new Error("Datei nicht gefunden");
                
                const json = await response.json();
                
                if(Array.isArray(json)) {
                    // Wir müssen jedem Workout eine stabile ID geben (Original Datum + Titel)
                    // Damit wir es wiedererkennen, auch wenn das Datum geändert wurde.
                    workouts = json.map(w => {
                        w._id = w.date + "_" + w.title; // Stabile ID
                        
                        // Prüfen, ob wir lokal ein anderes Datum gespeichert haben
                        if (dateOverrides[w._id]) {
                            w.displayDate = dateOverrides[w._id];
                        } else {
                            w.displayDate = w.date;
                        }
                        return w;
                    });

                    statusDot.className = 'status-dot online';
                    statusText.innerText = 'Online';
                    
                    if(workouts.length > 0 && !workouts.find(w => w.week === activeWeek)) {
                        activeWeek = workouts[0].week;
                    }
                    
                    renderTabs();
                    renderWorkouts();
                }
            } catch (error) {
                console.error(error);
                statusDot.className = 'status-dot error';
                statusText.innerText = 'Offline / Fehler';
            }
        }

        function renderTabs() {
            const weeks = [...new Set(workouts.map(w => w.week))];
            const container = document.getElementById('week-tabs');
            container.innerHTML = '';
            
            weeks.forEach(week => {
                const btn = document.createElement('div');
                btn.className = `tab ${week === activeWeek ? 'active' : ''}`;
                btn.innerText = week;
                btn.onclick = () => {
                    activeWeek = week;
                    renderTabs();
                    renderWorkouts();
                };
                container.appendChild(btn);
            });
        }

        function renderWorkouts() {
            const container = document.getElementById('workout-list');
            container.innerHTML = '';

            // Filtern und Sortieren basierend auf dem DISPLAY-DATUM (nicht dem Original)
            const filtered = workouts
                .filter(w => w.week === activeWeek)
                .sort((a,b) => new Date(a.displayDate) - new Date(b.displayDate));

            filtered.forEach((w) => {
                const isDone = progressData[w._id] === true;

                const dateObj = new Date(w.displayDate);
                const dateStr = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                const dayName = dateObj.toLocaleDateString('de-DE', { weekday: 'short' });
                
                const doneClass = isDone ? 'done' : '';
                const btnText = isDone ? 'Erledigt ✓' : 'Als erledigt markieren';
                const btnActive = isDone ? 'active' : '';

                let techHtml = w.technique || 'Grundposition';
                if(w.video_url) {
                    techHtml += `<br><a href="${w.video_url}" target="_blank" class="video-btn">▶ Video ansehen</a>`;
                }

                const html = `
                <div class="card ${doneClass}">
                    <div class="card-header">
                        <div class="date-wrapper">
                            <span class="date-badge">${dayName} ${dateStr}</span>
                            <input type="date" class="date-input" value="${w.displayDate}" onchange="updateDate('${w._id}', this.value)">
                        </div>
                        <div class="card-title">${w.title}</div>
                        <div class="card-duration">${w.duration}</div>
                    </div>
                    <div class="card-body">
                        <div class="description">${w.desc}</div>
                        <div class="code-container"><div class="code-text">${w.intervals_code || '-'}</div></div>
                        <div class="info-box"><div class="info-label">MNSTRY</div><div class="info-text">${w.nutrition || '-'}</div></div>
                        <div class="info-box tech-box"><div class="info-label">Technik</div><div class="info-text">${techHtml}</div></div>
                        <div class="action-row">
                            <button class="done-btn ${btnActive}" onclick="toggleDone('${w._id}')">${btnText}</button>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function toggleDone(id) {
            if (progressData[id]) { delete progressData[id]; } 
            else { progressData[id] = true; }
            localStorage.setItem('gravelProgress', JSON.stringify(progressData));
            renderWorkouts();
        }

        function updateDate(id, newDate) {
            if(!newDate) return;
            
            // Lokales Override speichern
            dateOverrides[id] = newDate;
            localStorage.setItem('gravelDates', JSON.stringify(dateOverrides));
            
            // In-Memory Daten aktualisieren
            const workout = workouts.find(w => w._id === id);
            if(workout) workout.displayDate = newDate;
            
            renderWorkouts();
        }

        init();
    </script>
</body>
</html>
