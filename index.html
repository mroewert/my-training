<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>R√∂wert - Gravel Coach</title>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A0E17">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="R√∂wert">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0A0E17;
            --bg-card: #131927;
            --bg-card-light: #1A2235;
            --bg-elevated: #232D42;
            
            --accent-primary: #E8944C;
            --accent-glow: rgba(232, 148, 76, 0.4);
            --accent-secondary: #4ECDC4;
            
            --status-green: #22C55E;
            --status-red: #EF4444;
            --status-blue: #3B82F6;
            --status-purple: #A855F7;
            --status-yellow: #EAB308;
            
            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            
            --border: #2D3A52;
            --radius: 16px;
            --radius-sm: 10px;
            
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }

        /* ============================================
           HEADER
        ============================================ */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(to bottom, var(--bg-deep) 0%, var(--bg-deep) 80%, transparent 100%);
            padding: 16px 16px 24px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), #D97706);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .logo-text h1 {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--text-primary), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-ftp {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ftp:hover { background: var(--bg-card-light); }
        .btn-ftp .label { font-size: 9px; color: var(--text-muted); font-weight: 600; }
        .btn-ftp .value { font-size: 14px; color: var(--accent-primary); font-weight: 700; }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-import {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        .btn-import:hover { transform: scale(1.05); }

        .btn-view {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-view:hover { background: var(--bg-card-light); }
        .btn-view.active { background: var(--accent-secondary); color: var(--bg-deep); }

        /* ============================================
           WEEK SUMMARY BAR
        ============================================ */
        .week-summary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .summary-item .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-item .sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .trend-up { color: var(--status-green); }
        .trend-down { color: var(--status-red); }
        .trend-neutral { color: var(--text-muted); }

        /* ============================================
           FORM CURVE
        ============================================ */
        .form-curve {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 16px;
        }

        .form-curve-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .form-curve-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-status {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .form-status.fresh { background: var(--status-green); color: #000; }
        .form-status.building { background: var(--status-blue); color: #fff; }
        .form-status.tired { background: var(--status-yellow); color: #000; }
        .form-status.overreaching { background: var(--status-red); color: #fff; }

        .form-bars {
            display: flex;
            align-items: flex-end;
            gap: 6px;
            height: 60px;
        }

        .form-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .form-bar {
            width: 100%;
            background: var(--bg-elevated);
            border-radius: 4px;
            position: relative;
            min-height: 8px;
            transition: all 0.3s ease;
        }

        .form-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: height 0.5s ease;
        }

        .form-bar-label {
            font-size: 9px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-bar-wrapper.current .form-bar {
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .form-bar-wrapper.current .form-bar-label {
            color: var(--accent-primary);
        }

        /* ============================================
           WEEK TABS
        ============================================ */
        .week-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
        }

        .week-tabs::-webkit-scrollbar { display: none; }

        .week-tab {
            flex-shrink: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .week-tab:hover { background: var(--bg-card-light); }

        .week-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .week-tab .week-num {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .week-tab.active .week-num { color: var(--bg-deep); }

        .week-tab .week-progress {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .week-tab.active .week-progress { color: var(--bg-deep); opacity: 0.8; }

        /* ============================================
           CONTENT
        ============================================ */
        .content {
            padding: 0 16px 100px;
        }

        /* ============================================
           WORKOUT CARDS
        ============================================ */
        .workout-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .workout-card.completed {
            opacity: 0.5;
            filter: grayscale(0.3);
        }

        .workout-card.is-today {
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px var(--accent-glow), inset 0 0 30px rgba(232, 148, 76, 0.05);
        }

        .card-header {
            display: flex;
            background: var(--bg-card-light);
        }

        .intensity-bar {
            width: 4px;
            flex-shrink: 0;
        }

        .intensity-bar.recovery { background: var(--status-green); }
        .intensity-bar.endurance { background: var(--status-blue); }
        .intensity-bar.threshold { background: var(--status-red); }
        .intensity-bar.sweetspot { background: var(--accent-primary); }

        .card-header-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            gap: 12px;
        }

        .card-header-left {
            flex: 1;
            min-width: 0;
        }

        .card-date-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .card-date {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .today-badge {
            background: var(--accent-primary);
            color: var(--bg-deep);
            font-size: 9px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 8px var(--accent-glow); }
            50% { box-shadow: 0 0 20px var(--accent-glow); }
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .card-duration {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .btn-edit {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .btn-edit:hover, .btn-edit.active {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Card Body */
        .card-body {
            padding: 14px;
        }

        .card-body.compact { display: none; }

        .workout-card.compact-view .card-body.full { display: none; }
        .workout-card.compact-view .card-body.compact { display: flex; align-items: center; justify-content: space-between; }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        /* Weather Alert */
        .weather-alert {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.15), transparent);
            border-left: 3px solid var(--status-yellow);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 10px 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .weather-icon {
            font-size: 24px;
        }

        .weather-info {
            flex: 1;
        }

        .weather-temp {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .weather-desc {
            font-size: 11px;
            color: var(--status-yellow);
        }

        /* Intervals Box */
        .intervals-box {
            background: var(--bg-deep);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 12px;
        }

        .intervals-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--status-green);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Info Boxes */
        .info-box {
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid;
        }

        .info-box.nutrition {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
            border-color: var(--status-red);
        }

        .info-box.technique {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
            border-color: var(--status-blue);
        }

        .info-box.coach-notes {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            border-color: var(--status-purple);
        }

        .info-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-box.nutrition .info-label { color: var(--status-red); }
        .info-box.technique .info-label { color: var(--status-blue); }
        .info-box.coach-notes .info-label { color: var(--status-purple); }

        .info-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .btn-video {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #DC2626;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            margin-top: 8px;
        }

        /* Comparison Box */
        .comparison-box {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.1), transparent);
            border-left: 3px solid var(--status-purple);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            padding: 12px;
            margin-bottom: 12px;
        }

        .comparison-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--status-purple);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .comparison-item .label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .comparison-item .value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .comparison-item .diff {
            font-size: 11px;
            margin-top: 2px;
        }

        .comparison-item .diff.good { color: var(--status-green); }
        .comparison-item .diff.warn { color: var(--status-yellow); }

        .comparison-notes {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }

        .card-actions-left {
            display: flex;
            gap: 8px;
        }

        .card-actions-right {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 10px 16px;
            border-radius: 24px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-delete {
            background: transparent;
            color: var(--status-red);
            padding: 10px 12px;
        }

        .btn-log {
            background: rgba(168, 85, 247, 0.2);
            color: var(--status-purple);
        }

        .btn-log:hover { background: rgba(168, 85, 247, 0.3); }

        .btn-complete {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .btn-complete:hover { background: var(--bg-card-light); }

        .btn-complete.active {
            background: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Compact Card Actions */
        .compact-actions {
            display: flex;
            gap: 8px;
        }

        .compact-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ============================================
           MODALS
        ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius) var(--radius) 0 0;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-deep);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            font-size: 15px;
            color: var(--text-primary);
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        textarea.form-input {
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card-light);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: var(--bg-deep);
        }

        /* Feeling Rating */
        .feeling-row {
            display: flex;
            gap: 8px;
        }

        .feeling-btn {
            flex: 1;
            aspect-ratio: 1;
            max-width: 50px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: var(--bg-card-light);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.4;
        }

        .feeling-btn.active {
            opacity: 1;
            border-color: var(--accent-primary);
            background: rgba(232, 148, 76, 0.2);
            transform: scale(1.1);
        }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-sm);
            border: none;
            background: var(--accent-primary);
            color: var(--bg-deep);
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .btn-primary:hover { transform: scale(1.02); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Strava Button */
        .btn-strava {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            background: #FC4C02;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        /* Danger Button */
        .btn-danger {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: none;
            background: rgba(239, 68, 68, 0.15);
            color: var(--status-red);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Divider */
        .divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        /* Log Workout Info */
        .log-workout-header {
            margin-bottom: 20px;
        }

        .log-workout-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .log-workout-date {
            font-size: 13px;
            color: var(--accent-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .empty-link {
            color: var(--accent-primary);
            text-decoration: underline;
            cursor: pointer;
        }

        /* ============================================
           ANIMATIONS
        ============================================ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .workout-card {
            animation: fadeIn 0.3s ease forwards;
        }

        /* ============================================
           UTILITY
        ============================================ */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="logo">
                <div class="logo-icon">üö¥</div>
                <div class="logo-text">
                    <h1>R√ñWERT</h1>
                    <span>Gravel Coach</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-ftp" onclick="openSettings()">
                    <span class="label">FTP</span>
                    <span class="value" id="ftp-display">185W</span>
                </button>
                <button class="btn-icon btn-view" onclick="toggleCompactMode()" id="btn-compact" title="Kompakt-Ansicht">‚ò∞</button>
                <button class="btn-icon btn-import" onclick="openImport()" title="Import">Ôºã</button>
            </div>
        </div>

        <!-- Week Summary -->
        <div class="week-summary" id="week-summary">
            <div class="summary-item">
                <div class="label">Soll</div>
                <div class="value" id="summary-target">0h</div>
            </div>
            <div class="summary-item">
                <div class="label">Ist</div>
                <div class="value" id="summary-actual">0h</div>
                <div class="sub" id="summary-percent">0%</div>
            </div>
            <div class="summary-item">
                <div class="label">Erledigt</div>
                <div class="value" id="summary-completed">0/0</div>
            </div>
            <div class="summary-item">
                <div class="label">Trend</div>
                <div class="value" id="summary-trend">‚Üí</div>
                <div class="sub" id="summary-trend-text">Stabil</div>
            </div>
        </div>

        <!-- Form Curve -->
        <div class="form-curve" id="form-curve">
            <div class="form-curve-header">
                <span class="form-curve-title">Formkurve (4 Wochen)</span>
                <span class="form-status" id="form-status">Aufbau</span>
            </div>
            <div class="form-bars" id="form-bars"></div>
        </div>

        <!-- Week Tabs -->
        <div class="week-tabs" id="week-tabs"></div>
    </div>

    <div class="content" id="workout-list"></div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="modal-import">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Plan Import</h2>
                <button class="modal-close" onclick="closeImport()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="toggle-group">
                    <button class="toggle-btn active" id="mode-replace" onclick="setImportMode('replace')">Ersetzen</button>
                    <button class="toggle-btn" id="mode-merge" onclick="setImportMode('merge')">Zusammenf√ºhren</button>
                </div>
                <div class="form-group">
                    <label class="form-label">JSON Daten</label>
                    <textarea class="form-input" id="import-text" placeholder='{"workouts": [...], "ftp": 185}'></textarea>
                </div>
                <button class="btn-primary" onclick="handleImport()">Importieren</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="modal-settings">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Einstellungen</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">FTP (Watt)</label>
                    <input type="number" class="form-input" id="settings-ftp" value="185">
                </div>
                
                <div class="divider"></div>
                
                <button class="btn-strava" onclick="connectStrava()">
                    <span>üîó</span> Mit Strava verbinden
                </button>
                
                <div class="divider"></div>
                
                <button class="btn-danger" onclick="resetData()">Alle Daten zur√ºcksetzen</button>
            </div>
        </div>
    </div>

    <!-- Log Workout Modal -->
    <div class="modal-overlay" id="modal-log">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Training loggen</h2>
                <button class="modal-close" onclick="closeLog()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="log-workout-header">
                    <div class="log-workout-title" id="log-title"></div>
                    <div class="log-workout-date" id="log-date"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dauer (min)</label>
                        <input type="number" class="form-input" id="log-duration" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label class="form-label">√ò Leistung (W)</label>
                        <input type="number" class="form-input" id="log-power" placeholder="optional">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Wie f√ºhlte es sich an?</label>
                    <div class="feeling-row" id="feeling-row">
                        <button class="feeling-btn" data-value="1">üò´</button>
                        <button class="feeling-btn" data-value="2">üòï</button>
                        <button class="feeling-btn" data-value="3">üòê</button>
                        <button class="feeling-btn" data-value="4">üôÇ</button>
                        <button class="feeling-btn active" data-value="5">üí™</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notizen</label>
                    <textarea class="form-input" id="log-notes" placeholder="Wie lief's? Intervalle geschafft?" style="min-height: 80px;"></textarea>
                </div>

                <button class="btn-primary" onclick="saveLog()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let workouts = [];
        let ftp = 185;
        let completed = {};
        let activityLogs = {};
        let selectedWeek = 0;
        let importMode = 'replace';
        let compactMode = false;
        let currentLogWorkoutId = null;
        let selectedFeeling = 5;
        let weatherCache = {};

        // ============================================
        // INITIAL DATA
        // ============================================
        const initialWorkouts = [
            {
                id: '2025-12-30_sweetspot',
                date: '2025-12-30',
                title: 'Sweetspot & Torque Intro',
                duration: '1h',
                desc: 'Wir starten mit Kraftausdauer. Die niedrige Trittfrequenz simuliert die Muskelspannung am Berg.',
                intervals: '- 15m 50% Warmup\n- 2x 10m 88% 60rpm (5m 50% recovery)\n- 10m 50% Cooldown',
                nutrition: '1 Flasche Wasser mit 1.5 Scoops Power Carb (ca. 70g)',
                technique: 'Runder Tritt: Ziehe das Pedal aktiv hoch.',
                video_url: 'https://www.youtube.com/watch?v=pdl92_gIDhw',
                coach_notes: ''
            },
            {
                id: '2026-01-04_endurance',
                date: '2026-01-04',
                title: 'Endurance & Low Cadence',
                duration: '2.5h',
                desc: 'Grundlage mit Kraft-Einlagen. Bei 60rpm ruhig im Oberk√∂rper bleiben.',
                intervals: '- 20m 55%\n- 3x 10m 78% 60rpm (10m 55% R)\n- 80m 65% Endurance\n- 10m 50%',
                nutrition: 'Pro Stunde 1 Scoop Power Carb. Insg. 2.5 Scoops.',
                technique: 'Aerodynamik: Intervalle im Unterlenker.',
                video_url: 'https://www.youtube.com/watch?v=ldvFqQeKAFU',
                coach_notes: ''
            },
            {
                id: '2026-01-06_threshold',
                date: '2026-01-06',
                title: 'Threshold & RPM Contrast',
                duration: '1h',
                desc: 'Der Wechsel zwischen 60rpm und 95rpm bei gleicher Wattzahl schult die neuromuskul√§re Effizienz.',
                intervals: '- 15m 55% Warmup\n- 3x 8m 95% (4m 60rpm / 4m 95rpm)\n- 10m 50%',
                nutrition: 'High Carb: 60g Carbs.',
                technique: 'Kadenz-Kontrolle: Kein Wippen im Sattel.',
                video_url: 'https://www.youtube.com/watch?v=Tq_wdIXXKcY',
                coach_notes: ''
            },
            {
                id: '2026-01-11_gravel',
                date: '2026-01-11',
                title: 'Long Gravel Ride',
                duration: '3h',
                desc: 'Suche bewusst schlechte Wege. Sand und Matsch f√ºr mehr Balance.',
                intervals: '- 180m 60-70% FTP Free Ride\n- 5x kurze Sand-Passagen',
                nutrition: '3 Scoops Power Carb + 1 Riegel nach 1.5h.',
                technique: 'Sand: Gewicht hinten, leichter Gang.',
                video_url: 'https://www.youtube.com/watch?v=M5fqQFSgB2Q',
                coach_notes: ''
            },
            {
                id: '2026-01-13_vo2max',
                date: '2026-01-13',
                title: 'VO2max Micro-Bursts',
                duration: '1h',
                desc: 'Kurz und hart. 30/30 Intervalle f√ºr maximale Sauerstoffaufnahme.',
                intervals: '- 15m 50%\n- 2x 10m (30s 120% / 30s 50%)\n- 15m 50%',
                nutrition: 'Wasser mit Elektrolyten.',
                technique: 'Wiegetritt: Erste 5 Sek. im Stehen.',
                video_url: 'https://www.youtube.com/watch?v=bOIs8MfkCME',
                coach_notes: ''
            },
            {
                id: '2026-01-18_biggear',
                date: '2026-01-18',
                title: 'Big Gear Endurance',
                duration: '3h',
                desc: 'K√∂nigsetappe. Kette rechts! Lange, flache Anstiege simulieren.',
                intervals: '- 30m 60%\n- 4x 15m 80-85% 60rpm (10m R)\n- Rest 65%',
                nutrition: '80g Carbs pro Stunde testen.',
                technique: 'Bike-Body-Separation in Kurven.',
                video_url: 'https://www.youtube.com/watch?v=GF0LfwuK-rc',
                coach_notes: ''
            },
            {
                id: '2026-01-20_recovery',
                date: '2026-01-20',
                title: 'Recovery Spin',
                duration: '45m',
                desc: 'Erholung. Locker kurbeln, Beine aussch√ºtteln.',
                intervals: '- 45m 50-55% steady state',
                nutrition: 'Nur Wasser.',
                technique: 'Souplesse: Geschmeidig treten.',
                video_url: '',
                coach_notes: ''
            },
            {
                id: '2026-01-25_social',
                date: '2026-01-25',
                title: 'Social Ride',
                duration: '2h',
                desc: 'Spa√üfahrt. Kopf frei. Keine roten Bereiche.',
                intervals: '- 120m HR < 75% Max',
                nutrition: '1 Riegel Reserve.',
                technique: 'Blickf√ºhrung: Weit voraus schauen.',
                video_url: 'https://www.youtube.com/watch?v=t1Eqt6tZdw4',
                coach_notes: ''
            }
        ];

        // ============================================
        // HELPERS
        // ============================================
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            return `${days[date.getDay()]} ${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        function parseDuration(duration) {
            const match = duration.match(/(\d+\.?\d*)\s*(h|m|min)/i);
            if (!match) return 60;
            const value = parseFloat(match[1]);
            const unit = match[2].toLowerCase();
            return unit === 'h' ? value * 60 : value;
        }

        function formatDurationHours(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return m > 0 ? `${h}h ${m}m` : `${h}h`;
        }

        function getIntensityClass(title) {
            const t = title.toLowerCase();
            if (t.includes('recovery') || t.includes('social')) return 'recovery';
            if (t.includes('vo2') || t.includes('threshold')) return 'threshold';
            if (t.includes('endurance') || t.includes('gravel')) return 'endurance';
            return 'sweetspot';
        }

        function isToday(dateStr) {
            const today = new Date();
            const date = new Date(dateStr);
            return date.toDateString() === today.toDateString();
        }

        function isFutureDate(dateStr) {
            return new Date(dateStr) > new Date();
        }

        // ============================================
        // DATA PERSISTENCE
        // ============================================
        function loadData() {
            try {
                const w = localStorage.getItem('gravel-workouts');
                const f = localStorage.getItem('gravel-ftp');
                const c = localStorage.getItem('gravel-completed');
                const a = localStorage.getItem('gravel-activities');

                workouts = w ? JSON.parse(w) : initialWorkouts;
                ftp = f ? parseInt(f) : 185;
                completed = c ? JSON.parse(c) : {};
                activityLogs = a ? JSON.parse(a) : {};

                document.getElementById('ftp-display').textContent = ftp + 'W';
                document.getElementById('settings-ftp').value = ftp;
            } catch (e) {
                console.error('Load error:', e);
                workouts = initialWorkouts;
            }
        }

        function saveData() {
            try {
                localStorage.setItem('gravel-workouts', JSON.stringify(workouts));
                localStorage.setItem('gravel-ftp', String(ftp));
                localStorage.setItem('gravel-completed', JSON.stringify(completed));
                localStorage.setItem('gravel-activities', JSON.stringify(activityLogs));
            } catch (e) {
                console.error('Save error:', e);
            }
        }

        // ============================================
        // WEEKS
        // ============================================
        function getWeeks() {
            if (workouts.length === 0) return [];
            const sorted = [...workouts].sort((a, b) => new Date(a.date) - new Date(b.date));
            const weeksMap = new Map();

            sorted.forEach(w => {
                const weekNum = getWeekNumber(new Date(w.date));
                const year = new Date(w.date).getFullYear();
                const key = `${year}-${weekNum}`;
                if (!weeksMap.has(key)) weeksMap.set(key, []);
                weeksMap.get(key).push(w);
            });

            return Array.from(weeksMap.values());
        }

        function findTodayWeek() {
            const weeks = getWeeks();
            const today = new Date();
            for (let i = 0; i < weeks.length; i++) {
                for (const w of weeks[i]) {
                    if (isToday(w.date)) return i;
                }
            }
            // Find closest future week
            for (let i = 0; i < weeks.length; i++) {
                for (const w of weeks[i]) {
                    if (new Date(w.date) >= today) return i;
                }
            }
            return 0;
        }

        // ============================================
        // WEEK SUMMARY
        // ============================================
        function updateWeekSummary() {
            const weeks = getWeeks();
            const currentWeekWorkouts = weeks[selectedWeek] || [];

            let targetMinutes = 0;
            let actualMinutes = 0;
            let completedCount = 0;

            currentWeekWorkouts.forEach(w => {
                targetMinutes += parseDuration(w.duration);
                if (completed[w.id]) {
                    completedCount++;
                    const log = activityLogs[w.id];
                    actualMinutes += log?.duration || parseDuration(w.duration);
                }
            });

            const percent = targetMinutes > 0 ? Math.round((actualMinutes / targetMinutes) * 100) : 0;

            document.getElementById('summary-target').textContent = formatDurationHours(targetMinutes);
            document.getElementById('summary-actual').textContent = formatDurationHours(actualMinutes);
            document.getElementById('summary-percent').textContent = percent + '%';
            document.getElementById('summary-percent').className = 'sub ' + (percent >= 90 ? 'trend-up' : percent >= 70 ? 'trend-neutral' : 'trend-down');
            document.getElementById('summary-completed').textContent = `${completedCount}/${currentWeekWorkouts.length}`;

            // Calculate trend vs previous week
            const prevWeekWorkouts = weeks[selectedWeek - 1] || [];
            let prevActual = 0;
            prevWeekWorkouts.forEach(w => {
                if (completed[w.id]) {
                    const log = activityLogs[w.id];
                    prevActual += log?.duration || parseDuration(w.duration);
                }
            });

            let trendIcon = '‚Üí';
            let trendText = 'Stabil';
            let trendClass = 'trend-neutral';

            if (prevActual > 0) {
                const diff = ((actualMinutes - prevActual) / prevActual) * 100;
                if (diff > 10) {
                    trendIcon = '‚Üë';
                    trendText = '+' + Math.round(diff) + '%';
                    trendClass = 'trend-up';
                } else if (diff < -10) {
                    trendIcon = '‚Üì';
                    trendText = Math.round(diff) + '%';
                    trendClass = 'trend-down';
                }
            }

            document.getElementById('summary-trend').textContent = trendIcon;
            document.getElementById('summary-trend').className = 'value ' + trendClass;
            document.getElementById('summary-trend-text').textContent = trendText;
        }

        // ============================================
        // FORM CURVE
        // ============================================
        function updateFormCurve() {
            const weeks = getWeeks();
            const container = document.getElementById('form-bars');
            container.innerHTML = '';

            // Calculate load for last 4 weeks relative to selected week
            const startIdx = Math.max(0, selectedWeek - 3);
            const weekLoads = [];

            for (let i = startIdx; i <= selectedWeek && i < weeks.length; i++) {
                let load = 0;
                weeks[i].forEach(w => {
                    if (completed[w.id]) {
                        const log = activityLogs[w.id];
                        load += log?.duration || parseDuration(w.duration);
                    }
                });
                weekLoads.push({
                    weekNum: getWeekNumber(new Date(weeks[i][0].date)),
                    load,
                    isCurrent: i === selectedWeek
                });
            }

            const maxLoad = Math.max(...weekLoads.map(w => w.load), 1);

            weekLoads.forEach(week => {
                const percent = (week.load / maxLoad) * 100;
                const wrapper = document.createElement('div');
                wrapper.className = 'form-bar-wrapper' + (week.isCurrent ? ' current' : '');
                wrapper.innerHTML = `
                    <div class="form-bar" style="height: 50px;">
                        <div class="form-bar-fill" style="height: ${Math.max(percent, 5)}%;"></div>
                    </div>
                    <span class="form-bar-label">KW${week.weekNum}</span>
                `;
                container.appendChild(wrapper);
            });

            // Determine form status
            const statusEl = document.getElementById('form-status');
            const currentLoad = weekLoads[weekLoads.length - 1]?.load || 0;
            const avgLoad = weekLoads.slice(0, -1).reduce((a, b) => a + b.load, 0) / Math.max(weekLoads.length - 1, 1);

            if (currentLoad < avgLoad * 0.7) {
                statusEl.textContent = 'Erholt';
                statusEl.className = 'form-status fresh';
            } else if (currentLoad > avgLoad * 1.3) {
                statusEl.textContent = '√úberlastung';
                statusEl.className = 'form-status overreaching';
            } else if (currentLoad > avgLoad * 1.1) {
                statusEl.textContent = 'Aufbau';
                statusEl.className = 'form-status building';
            } else {
                statusEl.textContent = 'Stabil';
                statusEl.className = 'form-status tired';
            }
        }

        // ============================================
        // WEATHER
        // ============================================
        let weatherFetchFailed = false;
        
        async function fetchWeather(dateStr) {
            // Skip if previous fetch failed (avoid repeated errors)
            if (weatherFetchFailed) return null;
            
            // Check cache
            if (weatherCache[dateStr]) return weatherCache[dateStr];

            try {
                // Using Open-Meteo API (free, no key required)
                // Bremen coordinates
                const lat = 53.0793;
                const lon = 8.8017;
                const date = new Date(dateStr);
                const today = new Date();
                const daysAhead = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

                // Only fetch for next 7 days
                if (daysAhead < 0 || daysAhead > 7) return null;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,precipitation_probability_max,weathercode&timezone=Europe/Berlin`,
                    { signal: controller.signal }
                );
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    weatherFetchFailed = true;
                    return null;
                }
                
                const data = await response.json();

                if (data.daily) {
                    for (let i = 0; i < data.daily.time.length; i++) {
                        const d = data.daily.time[i];
                        weatherCache[d] = {
                            temp: Math.round(data.daily.temperature_2m_max[i]),
                            rainProb: data.daily.precipitation_probability_max[i],
                            code: data.daily.weathercode[i]
                        };
                    }
                }

                return weatherCache[dateStr] || null;
            } catch (e) {
                // Silently fail - weather is optional
                weatherFetchFailed = true;
                return null;
            }
        }

        function getWeatherIcon(code) {
            // WMO Weather interpretation codes
            if (code <= 1) return '‚òÄÔ∏è';
            if (code <= 3) return '‚õÖ';
            if (code <= 48) return 'üå´Ô∏è';
            if (code <= 67) return 'üåßÔ∏è';
            if (code <= 77) return 'üå®Ô∏è';
            if (code <= 82) return 'üåßÔ∏è';
            if (code <= 86) return 'üå®Ô∏è';
            if (code <= 99) return '‚õàÔ∏è';
            return 'üå§Ô∏è';
        }

        function getWeatherWarning(weather) {
            if (!weather) return null;
            if (weather.rainProb > 70) return { type: 'rain', text: 'Hohe Regenwahrscheinlichkeit - Indoor-Alternative?' };
            if (weather.temp < 0) return { type: 'cold', text: 'Frost - Warm anziehen oder Indoor' };
            if (weather.temp > 30) return { type: 'heat', text: 'Hitze - Fr√ºh morgens fahren' };
            return null;
        }

        // ============================================
        // RENDER
        // ============================================
        function renderWeekTabs() {
            const weeks = getWeeks();
            const container = document.getElementById('week-tabs');
            container.innerHTML = '';

            weeks.forEach((week, idx) => {
                const weekNum = getWeekNumber(new Date(week[0].date));
                const completedCount = week.filter(w => completed[w.id]).length;
                const isActive = selectedWeek === idx;

                const tab = document.createElement('div');
                tab.className = 'week-tab' + (isActive ? ' active' : '');
                tab.innerHTML = `
                    <div class="week-num">KW ${weekNum}</div>
                    <div class="week-progress">${completedCount}/${week.length}</div>
                `;
                tab.onclick = () => {
                    selectedWeek = idx;
                    renderWeekTabs();
                    renderWorkouts();
                    updateWeekSummary();
                    updateFormCurve();
                };
                container.appendChild(tab);
            });
        }

        async function renderWorkouts() {
            const weeks = getWeeks();
            const currentWeekWorkouts = weeks[selectedWeek] || [];
            const container = document.getElementById('workout-list');

            if (currentWeekWorkouts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üö¥</div>
                        <div class="empty-text">Keine Workouts in dieser Woche</div>
                        <div class="empty-link" onclick="openImport()">Plan importieren</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            for (const workout of currentWeekWorkouts) {
                const isCompleted = completed[workout.id];
                const isTodayWorkout = isToday(workout.date);
                const log = activityLogs[workout.id];
                const intensityClass = getIntensityClass(workout.title);
                const weather = await fetchWeather(workout.date);
                const weatherWarning = getWeatherWarning(weather);

                // Soll-Ist Vergleich
                let comparisonHtml = '';
                if (log) {
                    const sollDuration = parseDuration(workout.duration);
                    const istDuration = log.duration || sollDuration;
                    const percent = Math.round((istDuration / sollDuration) * 100);
                    const percentClass = percent >= 90 ? 'good' : 'warn';

                    comparisonHtml = `
                        <div class="comparison-box">
                            <div class="comparison-title">Soll-Ist Vergleich</div>
                            <div class="comparison-grid">
                                <div class="comparison-item">
                                    <div class="label">Dauer</div>
                                    <div class="value">${istDuration}m / ${sollDuration}m</div>
                                    <div class="diff ${percentClass}">${percent}%</div>
                                </div>
                                ${log.avgPower ? `
                                <div class="comparison-item">
                                    <div class="label">√ò Leistung</div>
                                    <div class="value">${log.avgPower}W</div>
                                    <div class="diff">${Math.round((log.avgPower / ftp) * 100)}% FTP</div>
                                </div>
                                ` : ''}
                                <div class="comparison-item">
                                    <div class="label">Gef√ºhl</div>
                                    <div class="value">${'‚≠ê'.repeat(log.feeling || 3)}</div>
                                </div>
                            </div>
                            ${log.notes ? `<div class="comparison-notes">${log.notes}</div>` : ''}
                        </div>
                    `;
                }

                // Weather HTML
                let weatherHtml = '';
                if (weather && isFutureDate(workout.date) && !isCompleted) {
                    const warning = weatherWarning;
                    if (warning || weather.rainProb > 30) {
                        weatherHtml = `
                            <div class="weather-alert">
                                <span class="weather-icon">${getWeatherIcon(weather.code)}</span>
                                <div class="weather-info">
                                    <div class="weather-temp">${weather.temp}¬∞C | ${weather.rainProb}% Regen</div>
                                    ${warning ? `<div class="weather-desc">${warning.text}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                }

                // Coach Notes HTML
                let coachNotesHtml = '';
                if (workout.coach_notes) {
                    coachNotesHtml = `
                        <div class="info-box coach-notes">
                            <div class="info-label">Coach Notiz</div>
                            <div class="info-text">${workout.coach_notes}</div>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'workout-card' + 
                    (isCompleted ? ' completed' : '') + 
                    (isTodayWorkout ? ' is-today' : '') +
                    (compactMode ? ' compact-view' : '');
                card.style.animationDelay = `${currentWeekWorkouts.indexOf(workout) * 0.05}s`;

                card.innerHTML = `
                    <div class="card-header">
                        <div class="intensity-bar ${intensityClass}"></div>
                        <div class="card-header-content">
                            <div class="card-header-left">
                                <div class="card-date-row">
                                    <span class="card-date">${formatDate(workout.date)}</span>
                                    ${isTodayWorkout ? '<span class="today-badge">Heute</span>' : ''}
                                </div>
                                <div class="card-title">${workout.title}</div>
                            </div>
                            <div class="card-header-right">
                                <span class="card-duration">${workout.duration}</span>
                                <button class="btn-edit" onclick="toggleEdit('${workout.id}')">‚úé</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body full">
                        <p class="card-desc">${workout.desc}</p>
                        
                        ${weatherHtml}
                        
                        <div class="intervals-box">
                            <pre class="intervals-text">${workout.intervals}</pre>
                        </div>
                        
                        ${comparisonHtml}
                        
                        <div class="info-box nutrition">
                            <div class="info-label">Nutrition</div>
                            <div class="info-text">${workout.nutrition}</div>
                        </div>
                        
                        ${workout.technique ? `
                        <div class="info-box technique">
                            <div class="info-label">Technik</div>
                            <div class="info-text">${workout.technique}</div>
                            ${workout.video_url ? `<a href="${workout.video_url}" target="_blank" class="btn-video">‚ñ∂ Video</a>` : ''}
                        </div>
                        ` : ''}
                        
                        ${coachNotesHtml}
                        
                        <div class="card-actions">
                            <div class="card-actions-left">
                                <button class="btn-action btn-delete hidden" onclick="deleteWorkout('${workout.id}')">üóë L√∂schen</button>
                            </div>
                            <div class="card-actions-right">
                                ${!isCompleted ? `<button class="btn-action btn-log" onclick="openLog('${workout.id}')">Training loggen</button>` : ''}
                                <button class="btn-action btn-complete ${isCompleted ? 'active' : ''}" onclick="toggleComplete('${workout.id}')">
                                    ${isCompleted ? '‚úì Erledigt' : 'Erledigt'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body compact">
                        <span class="compact-status">${isCompleted ? '‚úì Erledigt' : ''}</span>
                        <div class="compact-actions">
                            ${!isCompleted ? `<button class="btn-action btn-log" onclick="openLog('${workout.id}')">Loggen</button>` : ''}
                            <button class="btn-action btn-complete ${isCompleted ? 'active' : ''}" onclick="toggleComplete('${workout.id}')">
                                ${isCompleted ? '‚úì' : '‚óã'}
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            }
        }

        // ============================================
        // ACTIONS
        // ============================================
        function toggleComplete(id) {
            completed[id] = !completed[id];
            saveData();
            renderWorkouts();
            renderWeekTabs();
            updateWeekSummary();
            updateFormCurve();
        }

        function deleteWorkout(id) {
            if (confirm('Workout wirklich l√∂schen?')) {
                workouts = workouts.filter(w => w.id !== id);
                delete completed[id];
                delete activityLogs[id];
                saveData();
                renderWorkouts();
                renderWeekTabs();
                updateWeekSummary();
                updateFormCurve();
            }
        }

        function toggleEdit(id) {
            const card = document.querySelector(`[onclick="toggleComplete('${id}')"]`).closest('.workout-card');
            const deleteBtn = card.querySelector('.btn-delete');
            const editBtn = card.querySelector('.btn-edit');
            
            deleteBtn.classList.toggle('hidden');
            editBtn.classList.toggle('active');
        }

        function toggleCompactMode() {
            compactMode = !compactMode;
            document.getElementById('btn-compact').classList.toggle('active', compactMode);
            renderWorkouts();
        }

        // ============================================
        // MODALS
        // ============================================
        function openImport() {
            document.getElementById('modal-import').classList.add('active');
        }

        function closeImport() {
            document.getElementById('modal-import').classList.remove('active');
        }

        function setImportMode(mode) {
            importMode = mode;
            document.getElementById('mode-replace').classList.toggle('active', mode === 'replace');
            document.getElementById('mode-merge').classList.toggle('active', mode === 'merge');
        }

        function handleImport() {
            const text = document.getElementById('import-text').value;
            try {
                const data = JSON.parse(text);
                let imported;

                if (data.ftp) ftp = data.ftp;
                imported = data.workouts || data;

                if (importMode === 'replace') {
                    workouts = imported;
                } else {
                    const existingMap = new Map(workouts.map(w => [w.id, w]));
                    imported.forEach(w => existingMap.set(w.id, w));
                    workouts = Array.from(existingMap.values());
                }

                document.getElementById('ftp-display').textContent = ftp + 'W';
                document.getElementById('settings-ftp').value = ftp;

                saveData();
                selectedWeek = findTodayWeek();
                renderWeekTabs();
                renderWorkouts();
                updateWeekSummary();
                updateFormCurve();
                closeImport();
                document.getElementById('import-text').value = '';

                alert(`${imported.length} Workouts importiert`);
            } catch (e) {
                alert('JSON-Fehler: ' + e.message);
            }
        }

        function openSettings() {
            document.getElementById('modal-settings').classList.add('active');
        }

        function closeSettings() {
            const newFtp = parseInt(document.getElementById('settings-ftp').value) || 185;
            ftp = newFtp;
            document.getElementById('ftp-display').textContent = ftp + 'W';
            saveData();
            document.getElementById('modal-settings').classList.remove('active');
        }

        function connectStrava() {
            alert('Strava-Integration kommt in Phase 2.\n\nF√ºr jetzt: Trage deine Daten manuell √ºber "Training loggen" ein.');
        }

        function resetData() {
            if (confirm('Wirklich alle Daten l√∂schen?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function openLog(id) {
            currentLogWorkoutId = id;
            const workout = workouts.find(w => w.id === id);
            const existingLog = activityLogs[id];

            document.getElementById('log-title').textContent = workout.title;
            document.getElementById('log-date').textContent = formatDate(workout.date);
            document.getElementById('log-duration').value = existingLog?.duration || parseDuration(workout.duration);
            document.getElementById('log-power').value = existingLog?.avgPower || '';
            document.getElementById('log-notes').value = existingLog?.notes || '';

            selectedFeeling = existingLog?.feeling || 5;
            updateFeelingButtons();

            document.getElementById('modal-log').classList.add('active');
        }

        function closeLog() {
            document.getElementById('modal-log').classList.remove('active');
            currentLogWorkoutId = null;
        }

        function updateFeelingButtons() {
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                const val = parseInt(btn.dataset.value);
                btn.classList.toggle('active', val <= selectedFeeling);
            });
        }

        function saveLog() {
            if (!currentLogWorkoutId) return;

            activityLogs[currentLogWorkoutId] = {
                duration: parseInt(document.getElementById('log-duration').value) || 60,
                avgPower: parseInt(document.getElementById('log-power').value) || 0,
                feeling: selectedFeeling,
                notes: document.getElementById('log-notes').value,
                loggedAt: new Date().toISOString()
            };

            completed[currentLogWorkoutId] = true;
            saveData();
            closeLog();
            renderWorkouts();
            renderWeekTabs();
            updateWeekSummary();
            updateFormCurve();
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            selectedWeek = findTodayWeek();
            renderWeekTabs();
            renderWorkouts();
            updateWeekSummary();
            updateFormCurve();

            // Feeling buttons
            document.querySelectorAll('.feeling-btn').forEach(btn => {
                btn.onclick = () => {
                    selectedFeeling = parseInt(btn.dataset.value);
                    updateFeelingButtons();
                };
            });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                };
            });
        });
    </script>
</body>
</html>
